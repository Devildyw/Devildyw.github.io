<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Spring Cloud-Hystrix | Devil的个人博客</title><meta name="keywords" content="Spring Cloud"><meta name="author" content="Devil"><meta name="copyright" content="Devil"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Spring Cloud-Hystrix前言分布式系统面临的问题 复杂分布式体系结构中的应用有数十个依赖关系，每个依赖关系在某些时候将不可避免地失败。    服务雪崩多个微服务之间调用的时候，假设微服务A调用微服务B和C，微服务B和微服务C又调用其他的微服务，这就是所谓的“扇出”。如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud-Hystrix">
<meta property="og:url" content="https://devildyw.github.io/2022/07/26/Spring%20Cloud-Hystrix/index.html">
<meta property="og:site_name" content="Devil的个人博客">
<meta property="og:description" content="Spring Cloud-Hystrix前言分布式系统面临的问题 复杂分布式体系结构中的应用有数十个依赖关系，每个依赖关系在某些时候将不可避免地失败。    服务雪崩多个微服务之间调用的时候，假设微服务A调用微服务B和C，微服务B和微服务C又调用其他的微服务，这就是所谓的“扇出”。如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-k7zdqm.png">
<meta property="article:published_time" content="2022-07-26T11:06:41.000Z">
<meta property="article:modified_time" content="2022-07-29T15:46:55.518Z">
<meta property="article:author" content="Devil">
<meta property="article:tag" content="Spring Cloud">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-k7zdqm.png"><link rel="shortcut icon" href="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/favicon.png"><link rel="canonical" href="https://devildyw.github.io/2022/07/26/Spring%20Cloud-Hystrix/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring Cloud-Hystrix',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-07-29 23:46:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/dyw.css"><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Devil的个人博客" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/avatar.png" onerror="onerror=null;src='https://tva1.sinaimg.cn/large/832afe33ly1gbi8718jtpg20r00lc776.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">87</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">32</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/myself/"><i class="fa-fw fa fa-id-card"></i><span> 自我介绍</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-k7zdqm.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Devil的个人博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/myself/"><i class="fa-fw fa fa-id-card"></i><span> 自我介绍</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring Cloud-Hystrix</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-26T11:06:41.000Z" title="发表于 2022-07-26 19:06:41">2022-07-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-29T15:46:55.518Z" title="更新于 2022-07-29 23:46:55">2022-07-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7/">服务降级</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spring Cloud-Hystrix"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Spring-Cloud-Hystrix"><a href="#Spring-Cloud-Hystrix" class="headerlink" title="Spring Cloud-Hystrix"></a>Spring Cloud-<code>Hystrix</code></h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>分布式系统面临的问题</strong></p>
<p>复杂分布式体系结构中的应用有数十个依赖关系，每个依赖关系在某些时候将不可避免地失败。</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727130210026.png" alt="image-20220727130210026"></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727130219748.png" alt="image-20220727130219748"></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727130235875.png" alt="image-20220727130235875"></p>
<h3 id="服务雪崩"><a href="#服务雪崩" class="headerlink" title="服务雪崩"></a>服务雪崩</h3><p>多个微服务之间调用的时候，假设微服务A调用微服务B和C，微服务B和微服务C又调用其他的微服务，这就是所谓的<strong>“扇出”</strong>。如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的<strong>“雪崩效应”</strong>。</p>
<p>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几秒钟内饱和。比失败更糟糕的时，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，不能取消整个应用或系统。</p>
<p>所以，</p>
<p>通常当你发现一个模块下的某个实例失败后，这时候这个模块依然还会接收流量，然后这个有问题得模块还调用了其他得模块，这样就会发生级联故障，或者叫<strong>雪崩</strong>。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>Hystrix</code>是一个用于处理分布式系统的<code>延迟</code>和<code>容错</code>的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，<code>Hystrix</code>能够保障在一个依赖出现问题下，<strong>不会导致整体服务失败，避免级联故障，以提高分布式提供的弹性。</strong></p>
<p><strong>“断路器”</strong>本身是一种开关装置，当某个服务单元发生故障后，通过断路器的故障监控（类似熔断保险丝），<strong>向调用发那个返回一个符合预期的，可处理的备选响应（<code>FallBack</code>）,而不是长时间的等待或者抛出调用方无法处理的异常</strong>，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。</p>
<blockquote>
<p><code>Github</code>官网：<a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix"><code>Netflix</code>&#x2F;<code>Hystrix</code></a></p>
</blockquote>
<p>目前<code>Hystrix</code>已经停止维护了，但其的思想是非常超前的，非常值得学习的，后续<code>Spring Cloud</code>大力推广的作为服务熔断的组件也都有借鉴<code>Hystrix</code>的思想。</p>
<h2 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h2><p><em><strong>熔断</strong></em>这一概念来源于电子工程中的<em><strong>断路器</strong></em>（Circuit Breaker）。</p>
<p>​     在互联网系统中，当下游服务因访问压力过大而响应变慢或失败，上游服务为了保护系统整体的可用性，可以暂时切断对下游服务的调用。</p>
<p>​     <strong>这种牺牲局部，保全整体的措施就叫做熔断。</strong></p>
<p>就是保险丝。服务的降级-&gt;进而熔断-&gt;恢复调用链路</p>
<h2 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h2><p>服务器忙，请稍后再试，不让客户端等待并立刻返回一个友好提示，<code>fallback</code></p>
<blockquote>
<p>服务降级在业务中就是指正常流程跑不通，先记录下来，然后再用程序去根据这些数据做补救</p>
</blockquote>
<p>那些情况会触发降级？</p>
<blockquote>
<p>程序运行异常、超时、服务熔断触发服务降级、线程池&#x2F;信号量打满也会导致服务降级。</p>
</blockquote>
<h2 id="服务限流"><a href="#服务限流" class="headerlink" title="服务限流"></a>服务限流</h2><p>秒杀高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行。</p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="新建父工程"><a href="#新建父工程" class="headerlink" title="新建父工程"></a>新建父工程</h3><ol>
<li><p>创建工程<code>Cloud-06-Hystrix</code></p>
</li>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Cloud-06-Hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.28<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.2.11<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mybatis.spring.boot.version</span>&gt;</span>2.1.1<span class="tag">&lt;/<span class="name">mybatis.spring.boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mybatis-plus</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">mybatis-plus</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--子模块继承之后，提供作用：锁定版本+子module不用谢groupId和version--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-project-info-reports-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--spring boot 2.2.2--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--spring cloud Hoxton.SR1--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--spring cloud 阿里巴巴--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- druid--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--mybatis--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--junit--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--log4j--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>SpringCloud-Hello-01<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">addResources</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addResources</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="创建子工程–服务生产者"><a href="#创建子工程–服务生产者" class="headerlink" title="创建子工程–服务生产者"></a>创建子工程–服务生产者</h3><ol>
<li><p>创建工程<code>Cloud-provider-hystrix-payment8001</code></p>
</li>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Cloud-06-Hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Cloud-provider-hystrix-payment8001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyw<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HystrixPaymentMain8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HystrixPaymentMain8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用正常的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池: &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot;paymentInfo_OK,id: &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(∩_∩)O哈哈~&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用延时的方法 用于后续根据延迟而发生服务熔断等</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(Integer id)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">timeNumber</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            TimeUnit.SECONDS.sleep(timeNumber);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池: &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot; paymentInfo_Timeout,id: &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(∩_∩)O哈哈~&quot;</span>+<span class="string">&quot;耗时:(秒) &quot;</span>+timeNumber;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Controller</code>控制器类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;payment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span>  paymentService.paymentInfo_OK(id);</span><br><span class="line">        log.info(<span class="string">&quot;****result: &#123;&#125;&quot;</span>,result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span>  paymentService.paymentInfo_Timeout(id);</span><br><span class="line">        log.info(<span class="string">&quot;****result: &#123;&#125;&quot;</span>,result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动测试</p>
<p><code>http://localhost:8001/payment/hystrix/timeout/1</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">线程池<span class="punctuation">:</span> http-nio<span class="number">-8001</span>-exec<span class="number">-2</span> paymentInfo_Timeout<span class="punctuation">,</span>id<span class="punctuation">:</span> <span class="number">1</span>	O(∩_∩)O哈哈~耗时<span class="punctuation">:</span>(秒) <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p><code>http://localhost:8001/payment/hystrix/ok/1</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">线程池<span class="punctuation">:</span> http-nio<span class="number">-8001</span>-exec<span class="number">-3</span>paymentInfo_OK<span class="punctuation">,</span>id<span class="punctuation">:</span> <span class="number">1</span>	O(∩_∩)O哈哈~</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>以上述为根基平台，从正确-&gt;错误-&gt;降级熔断-&gt;恢复</strong> </p>
<h2 id="JMeter高并发测压"><a href="#JMeter高并发测压" class="headerlink" title="JMeter高并发测压"></a><code>JMeter</code>高并发测压</h2><p>上述代码中我们有一个接口会在3秒中之后才会访问，我们并发量较小的时候访问，服务器是可以正常响应得，但是在分布式微服务的场景中会有大量得请求访问，此时会有大量得请求都会聚集在该接口等待3秒，请求量大又有大量得请求正在执行，就容易导致服务崩溃扛不住压力，所以这里我们用<code>JMeter</code>来测压演示一下。</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727131258444.png" alt="image-20220727131258444"></p>
<p><strong>创建线程组</strong></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727131357064.png" alt="image-20220727131357064"></p>
<p><strong>配置线程组得参数</strong></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727131447781.png" alt="image-20220727131447781"></p>
<p><strong>创建<code>Http</code>请求取样器</strong></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727131906737.png" alt="image-20220727131906737"></p>
<p><strong>设置请求参数</strong></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727132342332.png" alt="image-20220727132342332"></p>
<p><strong>启动</strong></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727132440011.png" alt="image-20220727132440011"></p>
<p>此时我们再去访问另一个接口<code>http://localhost:8001/payment/hystrix/ok/1</code>，会发现访问这个接口响应会有明显得延迟。</p>
<p><strong>这是因为tomcat得默认工作线程数被打满了，没有多余得线程来分解压力和处理。</strong></p>
<blockquote>
<p>Tomcat默认线程池有十个线程。</p>
</blockquote>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>上面那个服务<strong>提供者8001自己测试</strong>，加入此时外部得消费者80也来访问，那<strong>消费者</strong>只能干等，最终导致消费端80不满意，服务端8001直接被拖死，</p>
<h2 id="创建子工程–服务消费者"><a href="#创建子工程–服务消费者" class="headerlink" title="创建子工程–服务消费者"></a>创建子工程–服务消费者</h2><p><strong>将消费者加入正在进行压测的服务调用。</strong></p>
<ol>
<li><p>新建工程<code>Cloud-consumer-feign-hystrix-order80</code></p>
</li>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Cloud-06-Hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Cloud-consumer-feign-hystrix-order80<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyw<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Cloud-api-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>application.yml</code>配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">81</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># Eureka服务注册中心会将自己作为客户端来尝试注册它自己</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 我们要访问注册中心的服务所以这里必须为true 获取注册中心的服务列表信息</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">5000</span> <span class="comment">#连接超时的最大时限</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">5000</span> <span class="comment">#访问服务的最大时限 访问服务超过这个时间就会报错</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderHystrixMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderHystrixMain80.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Feign接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentHystrixService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Controller</code>类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;consumer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OderHystrixController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentHystrixService paymentHystrixService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.paymentInfo_OK(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.paymentInfo_Timeout(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动测试+服务生产者端得压力测试</p>
<p>服务消费者端调用服务会有明显的延迟，甚至可能出现超时的报错，这在分布式微服务的生产环境中是不允许出现的。</p>
</li>
</ol>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p><strong>解决的要求</strong></p>
<blockquote>
<p>超时导致服务器变慢–&gt;超时不再等待</p>
<p>出错(宕机或程序运行出错)–&gt;出错要有兜底</p>
</blockquote>
<p><strong>解决</strong></p>
<blockquote>
<p>对方服务(8001)超时了，调用者(80)不能一直卡死等待，必须有服务降级</p>
<p>对方服务(8001)down机了，调用者(80)不能一直卡死等待，必须有服务降级</p>
<p>对方服务(8001)OK，调用者自己出故障或有自我要求(自己的等待时间小于服务提供者，自己处理降级)</p>
</blockquote>
<h2 id="服务降级-1"><a href="#服务降级-1" class="headerlink" title="服务降级"></a>服务降级</h2><p>在服务的接口上新增注解<code>@HystrixCommand</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeoutHandler&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>fallbackMethod</code>：指定处理回退逻辑的方法。即如果方法出现超时或是报错就会调用的方法。</p>
<p><code>commandProperties</code>：指定命令属性。在这里配置发生上面情况才会调用<code>fallbackMethod</code>中的方法处理</p>
<p><code>@HystrixProperty</code>：用于配置<code>commandProperties</code>中的属性。降级处理超时时间设置<code>execution.isolation.thread.timeoutInMilliseconds</code>，value &#x3D; 3000表示超过三秒就会进行降级处理（默认1秒）。</p>
</blockquote>
<p><code>@HystrixProperty</code>全部配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* defaults */</span></span><br><span class="line"><span class="comment">/* package */</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_metricsRollingStatisticalWindow</span> <span class="operator">=</span> <span class="number">10000</span>;<span class="comment">// default =&gt; statisticalWindow: 10000 = 10 seconds (and default of 10 buckets so each bucket is 1 second)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_metricsRollingStatisticalWindowBuckets</span> <span class="operator">=</span> <span class="number">10</span>;<span class="comment">// default =&gt; statisticalWindowBuckets: 10 = 10 buckets in a 10 second window so each bucket is 1 second</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_circuitBreakerRequestVolumeThreshold</span> <span class="operator">=</span> <span class="number">20</span>;<span class="comment">// default =&gt; statisticalWindowVolumeThreshold: 20 requests in 10 seconds must occur before statistics matter</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_circuitBreakerSleepWindowInMilliseconds</span> <span class="operator">=</span> <span class="number">5000</span>;<span class="comment">// default =&gt; sleepWindow: 5000 = 5 seconds that we will sleep before trying again after tripping the circuit</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_circuitBreakerErrorThresholdPercentage</span> <span class="operator">=</span> <span class="number">50</span>;<span class="comment">// default =&gt; errorThresholdPercentage = 50 = if 50%+ of requests in 10 seconds are failures or latent then we will trip the circuit</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_circuitBreakerForceOpen</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">// default =&gt; forceCircuitOpen = false (we want to allow traffic)</span></span><br><span class="line"><span class="comment">/* package */</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_circuitBreakerForceClosed</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">// default =&gt; ignoreErrors = false </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_executionTimeoutInMilliseconds</span> <span class="operator">=</span> <span class="number">1000</span>; <span class="comment">// default =&gt; executionTimeoutInMilliseconds: 1000 = 1 second</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_executionTimeoutEnabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutionIsolationStrategy</span> <span class="variable">default_executionIsolationStrategy</span> <span class="operator">=</span> ExecutionIsolationStrategy.THREAD;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_executionIsolationThreadInterruptOnTimeout</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_executionIsolationThreadInterruptOnFutureCancel</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_metricsRollingPercentileEnabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_requestCacheEnabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_fallbackIsolationSemaphoreMaxConcurrentRequests</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_fallbackEnabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_executionIsolationSemaphoreMaxConcurrentRequests</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_requestLogEnabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">default_circuitBreakerEnabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_metricsRollingPercentileWindow</span> <span class="operator">=</span> <span class="number">60000</span>; <span class="comment">// default to 1 minute for RollingPercentile </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_metricsRollingPercentileWindowBuckets</span> <span class="operator">=</span> <span class="number">6</span>; <span class="comment">// default to 6 buckets (10 seconds each in 60 second window)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_metricsRollingPercentileBucketSize</span> <span class="operator">=</span> <span class="number">100</span>; <span class="comment">// default to 100 values max per bucket</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">default_metricsHealthSnapshotIntervalInMilliseconds</span> <span class="operator">=</span> <span class="number">500</span>; <span class="comment">// default to 500ms as max frequency between allowing snapshots of health (error percentage etc)</span></span><br></pre></td></tr></table></figure>

<h3 id="生产者降级保护"><a href="#生产者降级保护" class="headerlink" title="生产者降级保护"></a>生产者降级保护</h3><p>为了防止大量请求调用生产者端发生超时或者报错导致服务宕机，从而进行服务端的降级保护</p>
<p>对服务生产者Service接口进行改造<code>Cloud-provider-hystrix-payment8001</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用延时的方法 用于后续根据延迟而发生服务熔断等</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeoutHandler&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(Integer id)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">timeNumber</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">//        int age = 10/0; //使其发生报错</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            TimeUnit.SECONDS.sleep(timeNumber);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池: &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot; paymentInfo_Timeout,id: &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(∩_∩)O哈哈~&quot;</span>+<span class="string">&quot;耗时:(秒) &quot;</span>+timeNumber;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//fallbackMethod方法 执行服务降级时 调用该方法返回一个友好提示</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeoutHandler</span><span class="params">(Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池: &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot; 运行报错请稍后再试,id: &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;┭┮﹏┭┮&quot;</span>+<span class="string">&quot;耗时:(秒) &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主启动类添加注解<code>@EnableCircuitBreaker</code>激活<code>Hystrix</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span> <span class="comment">//激活Hystrix</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HystrixPaymentMain8001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HystrixPaymentMain8001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新启动服务 <strong>演示超时降级</strong></p>
<p>服务消费者调用访问接口<code>http://localhost:80/consumer/payment/hystrix/timeout/1</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">线程池<span class="punctuation">:</span> hystrix-PaymentService<span class="number">-6</span> 运行报错请稍后再试<span class="punctuation">,</span>id<span class="punctuation">:</span> <span class="number">1</span>	┭┮﹏┭┮耗时<span class="punctuation">:</span>(秒) </span><br></pre></td></tr></table></figure>

<p>将服务接口的延时注释掉，添加 <code>int age = 10/0;</code> 使其调用时会抛出异常导致报错</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用延时的方法 用于后续根据延迟而发生服务熔断等</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeoutHandler&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(Integer id)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">timeNumber</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">10</span>/<span class="number">0</span>; <span class="comment">//使其发生报错</span></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            TimeUnit.SECONDS.sleep(timeNumber);</span></span><br><span class="line"><span class="comment">//        &#125; catch (InterruptedException e) &#123;</span></span><br><span class="line"><span class="comment">//            throw new RuntimeException(e);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池: &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot; paymentInfo_Timeout,id: &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;O(∩_∩)O哈哈~&quot;</span>+<span class="string">&quot;耗时:(秒) &quot;</span>+timeNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//fallbackMethod方法 执行服务降级时 调用该方法返回一个友好提示</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_TimeoutHandler</span><span class="params">(Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池: &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot; 运行报错请稍后再试,id: &quot;</span>+id+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;┭┮﹏┭┮&quot;</span>+<span class="string">&quot;耗时:(秒) &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新启动服务 <strong>演示报错降级</strong></p>
<p>服务消费者调用访问接口<code>http://localhost:80/consumer/payment/hystrix/timeout/1</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">线程池<span class="punctuation">:</span> hystrix-PaymentService<span class="number">-1</span> 运行报错请稍后再试<span class="punctuation">,</span>id<span class="punctuation">:</span> <span class="number">1</span>	┭┮﹏┭┮耗时<span class="punctuation">:</span>(秒) </span><br></pre></td></tr></table></figure>

<p><strong>降级成功</strong></p>
<h3 id="消费者降级保护"><a href="#消费者降级保护" class="headerlink" title="消费者降级保护"></a>消费者降级保护</h3><p>服务消费者(对于用户而言仍然是消费者)，为了可以更好的保护自己，也可以依样画葫芦的对客户端降级保护。(一般将<code>Hystrix</code>防在客户端)</p>
<ol>
<li><p><code>application.yml</code>配置<code>openfeign</code>对<code>hystrix</code>的支持。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类添加注解<code>@EnableHystrix</code>激活 <code>Hystrix</code>特性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableHystrix</span> <span class="comment">//激活Hystrix</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderHystrixMain80</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(OrderHystrixMain80.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Controller</code>类中配置<code>Hystrix</code>接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;consumer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OderHystrixController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentHystrixService paymentHystrixService;</span><br><span class="line"></span><br><span class="line">   	......</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentTimeoutFallbackMethod&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;1500&quot;)</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.paymentInfo_Timeout(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentTimeoutFallbackMethod</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池: &quot;</span>+Thread.currentThread().getName()+<span class="string">&quot; 我是消费者80对方支付系统繁忙请10秒后再试或者自己运行出错检查自己,┭┮﹏┭┮&quot;</span>+<span class="string">&quot;耗时:(秒) &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动调用测试接口</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">线程池<span class="punctuation">:</span> hystrix-OderHystrixController<span class="number">-1</span> 我是消费者<span class="number">80</span>对方支付系统繁忙请<span class="number">10</span>秒后再试或者自己运行出错检查自己<span class="punctuation">,</span>┭┮﹏┭┮耗时<span class="punctuation">:</span>(秒) </span><br></pre></td></tr></table></figure>

<p>测试成功</p>
</li>
</ol>
<h3 id="全局服务降级配置"><a href="#全局服务降级配置" class="headerlink" title="全局服务降级配置"></a>全局服务降级配置</h3><p>为了防止为每一个服务都配置一个单独的降级方法导致的代码量上升，于是有了全局服务降级配置。</p>
<p><code>@DefaultProperties(defaultFallback = &quot;&quot;)</code></p>
<p>**<code>1:1</code>**： 每个方法配置一个服务降级方法，技术可以，实际上傻X</p>
<p>**<code>1:N</code>**：除了个别重要核心业务有专属方法，其他平台的可以通过<code>@DefaultProperties(defaultFallback=&quot;&quot;)</code>统一跳转到统一处理结果页面。</p>
<p><strong>通用的和独享的各自分开，避免了代码膨胀，合理减少了代码量。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//全局fallback</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">payment_Global_FallbackMethod</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Global异常处理信息, 请稍后再试, ┭┮﹏┭┮&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置全局fallback</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DefaultProperties(defaultFallback = &quot;payment_Global_FallbackMethod&quot;)</span> <span class="comment">//配置全局fallback</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;consumer&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OderHystrixController</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释接口上原有的<code>fallback</code>配置，使其受到全局<code>fallback</code>影响</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//    @HystrixCommand(fallbackMethod = &quot;paymentTimeoutFallbackMethod&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="comment">//            @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;1500&quot;)</span></span><br><span class="line"><span class="comment">//    &#125;)</span></span><br><span class="line">    <span class="meta">@HystrixCommand</span> <span class="comment">//注释掉原来的fallback 使其收到全局fallback影响</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentHystrixService.paymentInfo_Timeout(id);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>启动服务测试接口<code>http://localhost:80/consumer/payment/hystrix/timeout/1</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">Global异常处理信息<span class="punctuation">,</span> 请稍后再试<span class="punctuation">,</span> ┭┮﹏┭┮</span><br></pre></td></tr></table></figure>

<p>测试成功</p>
<h3 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a>解耦</h3><p>无论是为每一个服务都配置一个单独的服务降级方法，还是创建一个全局服务降级方法，都会导致大量代码耦合到<code>Controller</code>。</p>
<p>本次案例服务降级处理是在客户端80实现完成的，与服务端8001没有关系</p>
<p>只需要为<code>Feign</code>客户端定义的接口添加一个服务降级处理的实现类即可实现解耦</p>
<p>新建类实现<code>Feign</code>接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span> <span class="comment">//实现了Feign接口 实现其的方法就相当于为每个接口内服务提供了fallback方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title class_">PaymentHystrixService</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;----------------PaymentHystrixService fall back-PaymentInfo_OK,┭┮﹏┭┮&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;----------------PaymentHystrixService fall back-PaymentInfo_TimeOut,┭┮﹏┭┮&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再将该类配置到Feign接口中</p>
<p><code>@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;, fallback = PaymentFallbackService.class)</code></p>
<p><code>@FeignClient</code><strong>注解中的<code>fallback</code>参数是用来配置服务降级处理的实现类的</strong></p>
<p>这样<code>CLOUD-PROVIDER-HYSTRIX-PAYMENT</code>服务下的<code>Feign</code>接口方法就会被处理降级的实现类来管理了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;CLOUD-PROVIDER-HYSTRIX-PAYMENT&quot;, fallback = PaymentFallbackService.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentHystrixService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentInfo_Timeout</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动测试 注意：这里我们访问的接口是<code>http://localhost:80/consumer/payment/hystrix/ok/1</code>，该接口并没有带上<code>@HystrixCommand</code>所以并不会收到原本我们<code>Controller</code>中配置的全局降级处理。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">----------------PaymentHystrixService fall back-PaymentInfo_OK<span class="punctuation">,</span>┭┮﹏┭┮</span><br></pre></td></tr></table></figure>

<p>测试成功。</p>
<p><strong>全局降级处理 &gt; Feign接口的配置处理降级实现类</strong></p>
<h2 id="服务熔断-1"><a href="#服务熔断-1" class="headerlink" title="服务熔断"></a>服务熔断</h2><p><strong>熔断机制概述</strong></p>
<p>熔断机制是应对雪崩效应的一种微服务链路保护机制。当扇出链路的某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。</p>
<p><strong>当检测到节点微服务调用响应正常后，恢复调用链路。</strong></p>
<p>在Spring Cloud框架里，熔断机制通过<code>Hystrix</code>实现。<code>Hystrix</code>会监控微服务间调用的状态，当失败的调用到一定阈值，缺省是5秒内20次调用失败，就会启动熔断机制。熔断机制的注解是<code>@HystrixCommand</code>。</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/state.png" alt="img"></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/10162355X-7.png" alt="熔断状态转换"></p>
<blockquote>
<p>This simple circuit breaker avoids making the protected call when the circuit is open, but would need an external intervention to reset it when things are well again. This is a reasonable approach with electrical circuit breakers in buildings, but for software circuit breakers we can have the breaker itself detect if the underlying calls are working again. We can implement this self-resetting behavior by trying the protected call again after a suitable interval, and resetting the breaker should it succeed.</p>
<p>翻译：</p>
<p>这个简单的断路器避免了在电路打开时进行受保护的调用，但是当一切恢复正常时需要外部干预来重置它。对于建筑物中的电气断路器，这是一种合理的方法，但对于软件断路器，我们可以让断路器本身检测底层调用是否再次工作。我们可以通过在适当的时间间隔后再次尝试受保护的调用来实现这种自重置行为，并在成功时重置断路器。</p>
</blockquote>
<p>服务熔断三种状态：<strong>关</strong>，<strong>半开</strong>，<strong>全开</strong></p>
<blockquote>
<p>服务熔断：<a target="_blank" rel="noopener" href="https://martinfowler.com/bliki/CircuitBreaker.html"><code>CircuitBreaker-martinfowler</code></a></p>
</blockquote>
<h3 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h3><p>修改<code>Cloud-provider-hystrix-payment8001</code></p>
<p><code>PaymentService</code> 新增方法配置服务熔断相关项</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="comment">//======服务熔断</span></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;), //是否开启断路器 开启</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value =&quot;10&quot;),//请求次数 10次</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;),//时间窗口期单位毫秒(ms) 此属性设置在电路跳闸后拒绝请求的时间量，然后再允许尝试确定电路是否应再次闭合。</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;)//失败率达到多少 断路器就会打开</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (id &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;*****id 不能为负数&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">serialNumber</span> <span class="operator">=</span> IdUtil.simpleUUID();</span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;调用成功,流水号：&quot;</span>+serialNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker_fallback</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;id 不能为负数，请稍后再试 ┭┮﹏┭┮ id: &quot;</span>+id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>Controller</code>类新增接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//====服务熔断</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/circuit/&#123;id&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span>&#123;</span><br><span class="line">       <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> paymentService.paymentCircuitBreaker(id);</span><br><span class="line">       log.info(<span class="string">&quot;*****result: &#123;&#125;&quot;</span>,result);</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>启动服务访问</p>
<p>我们先疯狂使用负数去访问使得的服务调用报错，服务调用失败，只要我们在十次请求之中服务失败率超过了我们设置的60%，断路器就会打开。</p>
<p><code>http://localhost:8001/payment/circuit/-1</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">id 不能为负数，请稍后再试 ┭┮﹏┭┮ id<span class="punctuation">:</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>

<p>在外面疯狂访问下服务调用失败率已经远远大于60%</p>
<p>此时我们使用正常数据去访问接口，检测是否断路器打开。</p>
<p><code>http://localhost:8001/payment/circuit/1</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">id 不能为负数，请稍后再试 ┭┮﹏┭┮ id<span class="punctuation">:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>可以发现我们使用了正常的数据去访问服务，服务依旧是调用了服务降级的处理方法返回了一个服务报错才会返回的字符串，说明此时服务已经熔断。在服务窗口期过后短路器由全开转到半开，此时会释放一次请求访问，如果请求成功，断路器就会有半开转到关闭(<strong>恢复调用链路</strong>)，否则断路器继续打开，重新计时。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><strong>熔断打开</strong></p>
<p>请求不再进行调用当前服务，内部设置时钟一般为<code>MTR</code>（平均故障处理时间），当打开时长达到所设时钟则进入半熔断状态</p>
<p><strong>熔断关闭</strong></p>
<p>熔断关闭不会对服务进行熔断</p>
<p><strong>熔断半开</strong></p>
<p>部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务恢复正常，关闭熔断（恢复调用链路）。</p>
<h3 id="断路器在什么情况下起作用"><a href="#断路器在什么情况下起作用" class="headerlink" title="断路器在什么情况下起作用"></a>断路器在什么情况下起作用</h3><blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;)</span>, <span class="comment">//是否开启断路器 开启</span></span><br><span class="line"><span class="meta">@HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value =&quot;10&quot;)</span>,<span class="comment">//请求次数 10次</span></span><br><span class="line"><span class="meta">@HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;)</span>,<span class="comment">//时间窗口期单位毫秒(ms) 此属性设置在电路跳闸后拒绝请求的时间量，然后再允许尝试确定电路是否应再次闭合。</span></span><br><span class="line"><span class="meta">@HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;)</span><span class="comment">//失败率达到多少 发生断路</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>上述配置涉及到断路器的三个重要参数：<strong>快照时间窗</strong>、<strong>请求总数阈值</strong>、<strong>错误百分比阈值</strong>。</p>
<ol>
<li>快照时间窗：此属性设置在电路跳闸后拒绝请求的时间量，超过该事件进入电路半跳闸状态，然后再允许尝试确定电路是否应再次闭合。</li>
<li>请求总数阈值：在快照时间窗内，必须满足请求总数阈值才有资格熔断。默认20，意味着在10秒内，如果该<code>Hystrix</code>命令的调用次数不足20次，即使所有的请求都超时或其他原因失败，断路器都不会打开。</li>
<li>错误百分比阈值：当请求总数在快照时间窗内超过了阈值，比如发生了30次调用，如果在这30次调用中，有15次发生了超时异常，也就是超过50%错误百分比，在默认设定50%阈值情况下，这时候就会将断路器打开。</li>
</ol>
<h3 id="断路器开启或关闭的条件"><a href="#断路器开启或关闭的条件" class="headerlink" title="断路器开启或关闭的条件"></a>断路器开启或关闭的条件</h3><p><strong>开启条件</strong></p>
<ul>
<li>当满足一定的阈值的时候（默认10秒内超过20个请求次数）</li>
<li>当失败率达到一定的时候（默认10秒内超过50%的请求次数）</li>
</ul>
<p>当开启的时候，所有请求都不会进行转发</p>
<p><strong>关闭条件</strong></p>
<ul>
<li>一段时间之后（默认是5秒），这个时候断路器是半开状态，会让其中一个请求进行转发。如果成功，断路器会关闭，若失败，继续开启。开启状态参考上述，后过一段时间又会进入半开状态。</li>
</ul>
<h3 id="断路器打开之后"><a href="#断路器打开之后" class="headerlink" title="断路器打开之后"></a>断路器打开之后</h3><ol>
<li><p>再有请求调用的时候，将不会调用主逻辑，而是直接调用降级fallback。通过断路器，实现了自动地发现错误并将降级逻辑切换为主逻辑，减少响应延迟的效果。</p>
</li>
<li><p>原来的主逻辑要如何恢复呢？</p>
<p>对于这一问题，hystrix也为我们实现了自动恢复功能。</p>
<p>当断路器打开，对主逻辑进行熔断之后，<code>hystrix</code>会启动一个休眠时间窗，在这个时间窗内，降级逻辑是临时的成为主逻辑，当休眠时间窗到期，断路器将进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，那么断路器将继续闭合，主逻辑恢复如果这次请求依然有问题，断路器继续进入打开状态，休眠时间窗重新计时。</p>
</li>
</ol>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p><strong>以下配置在<code>HystrixCommandProperties</code>中都有对应。</strong></p>
<h3 id="Command-Properties（指令参数）"><a href="#Command-Properties（指令参数）" class="headerlink" title="Command Properties（指令参数）"></a>Command Properties（指令参数）</h3><p><strong>以下属性控制<code>HystrixCommand</code>行为：</strong></p>
<h4 id="Execution（执行）"><a href="#Execution（执行）" class="headerlink" title="Execution（执行）"></a>Execution（执行）</h4><h5 id="隔离策略"><a href="#隔离策略" class="headerlink" title="隔离策略"></a>隔离策略</h5><ul>
<li><strong>execution.isolation.strategy</strong></li>
</ul>
<p>隔离策略决定<code>Hystrix</code>命令执行的时候采用什么类型的策略进行依赖隔离。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>THREAD</code> (见<code>ExecutionIsolationStrategy.THREAD</code>)</td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>THREAD</code>,<code>SEMAPHORE</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.execution.isolation.strategy</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].execution.isolation.strategy</code></td>
</tr>
</tbody></table>
<p>执行隔离策略到底选择线程池(<code>THREAD</code>)还是信号量(<code>SEMAPHORE</code>)？文档中给出的建议是：</p>
<blockquote>
<p>使用<code>HystrixCommand</code>的时候建议用<code>THREAD</code>策略，使用<code>HystrixObservableCommand</code>的时候建议使用<code>SEMAPHORE</code>策略。</p>
</blockquote>
<blockquote>
<p>使用<code>THREAD</code>策略让<code>HystrixCommand</code>在线程中执行可以提供额外的保护层，以防止因为网络超时导致的延时失败。</p>
</blockquote>
<blockquote>
<p>一般情况下，只有这种特殊例子下<code>HystrixCommand</code>会搭配<code>SEMAPHORE</code>策略使用：调用的频次太高(例如每个实例每秒数百次调用)，这种情况如果选用<code>THREAD</code>策略有可能导致超过线程隔离的上限(有可能需要太多的线程或者命令太多线程不足够用于隔离请求)，这种情况一般是非网络请求调用。</p>
</blockquote>
<p><strong>笔者想说的是：建议选用默认值，因为目前很少遇到使用信号量隔离的场景。</strong></p>
<h5 id="是否允许超时"><a href="#是否允许超时" class="headerlink" title="是否允许超时"></a>是否允许超时</h5><ul>
<li><strong>execution.timeout.enabled</strong></li>
</ul>
<p>决定<code>HystrixCommand#run()</code>执行时是否允许超时，只有设置为true的时候，下面提到的“超时时间上限”才会有效。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>true</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>true</code>,<code>false</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.execution.timeout.enabled</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].execution.timeout.enabled</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">保持选用默认值</td>
</tr>
</tbody></table>
<h5 id="超时时间上限"><a href="#超时时间上限" class="headerlink" title="超时时间上限"></a>超时时间上限</h5><ul>
<li><strong>execution.isolation.thread.timeoutInMilliseconds</strong></li>
</ul>
<p><code>HystrixCommand</code>执行时候超时的最大上限，单位是毫秒，如果命令执行耗时超过此时间值那么会进入降级逻辑。这个配置生效的前提是<code>hystrix.command.default.execution.timeout.enabled</code>或者<code>hystrix.command.[HystrixCommandKey].execution.timeout.enabled</code>为true。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>1000</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].execution.isolation.thread.timeoutInMilliseconds</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center"><strong>保持选用默认值</strong></td>
</tr>
</tbody></table>
<h5 id="超时是否中断"><a href="#超时是否中断" class="headerlink" title="超时是否中断"></a>超时是否中断</h5><p>此配置项决定<code>HystrixCommand#run()</code>执行的时候调用超时的情况下是否中断。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>true</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>true</code>、<code>false</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.execution.isolation.thread.interruptOnTimeout</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].execution.isolation.thread.interruptOnTimeout</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center"><strong>保持选用默认值</strong></td>
</tr>
</tbody></table>
<h5 id="取消是否中断"><a href="#取消是否中断" class="headerlink" title="取消是否中断"></a>取消是否中断</h5><ul>
<li><strong>execution.isolation.thread.interruptOnCancel</strong></li>
</ul>
<p>此配置项决定<code>HystrixCommand#run()</code>执行的时候取消调用的情况下是否中断。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>false</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>true</code>、<code>false</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.execution.isolation.thread.interruptOnCancel</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].execution.isolation.thread.interruptOnCancel</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center"><strong>保持选用默认值</strong></td>
</tr>
</tbody></table>
<h5 id="最大并发请求上限-SEMAPHORE"><a href="#最大并发请求上限-SEMAPHORE" class="headerlink" title="最大并发请求上限(SEMAPHORE)"></a>最大并发请求上限(SEMAPHORE)</h5><ul>
<li><strong>execution.isolation.semaphore.maxConcurrentRequests</strong></li>
</ul>
<p>此配置项决定使用<code>HystrixCommand#run()</code>方法和<code>ExecutionIsolationStrategy.SEMAPHORE</code>隔离策略下并发请求数量的最高上限。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>10</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].execution.isolation.semaphore.maxConcurrentRequests</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center"><strong>必须根据实际情况设定此值</strong></td>
</tr>
</tbody></table>
<hr>
<h4 id="命令降级-fallback-配置"><a href="#命令降级-fallback-配置" class="headerlink" title="命令降级(fallback)配置"></a>命令降级(<code>fallback</code>)配置</h4><p>命令降级配置控制<code>HystrixCommand#getFallback()</code>的执行逻辑，所有命令降级配置对策略<code>ExecutionIsolationStrategy.THREAD</code>或者<code>ExecutionIsolationStrategy.SEMAPHORE</code>都生效。</p>
<h5 id="最大并发降级请求处理上限"><a href="#最大并发降级请求处理上限" class="headerlink" title="最大并发降级请求处理上限"></a>最大并发降级请求处理上限</h5><ul>
<li><strong>fallback.isolation.semaphore.maxConcurrentRequests</strong></li>
</ul>
<p>这个属性用于控制一个<code>HystrixCommand#getFallback()</code>实例方法在执行线程中调用的最大上限，如果超过此上限，降级逻辑不会执行并且会抛出一个异常。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>10</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].fallback.isolation.semaphore.maxConcurrentRequests</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">必须根据实际情况设定此值</td>
</tr>
</tbody></table>
<h5 id="是否开启降级"><a href="#是否开启降级" class="headerlink" title="是否开启降级"></a>是否开启降级</h5><ul>
<li><strong>fallback.enabled</strong></li>
</ul>
<p>此属性控制当<code>HystrixCommand</code>执行失败之后是否调用<code>HystrixCommand#getFallback()</code>。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>true</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>false</code>、<code>true</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.fallback.enabled</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].fallback.enabled</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<hr>
<h4 id="断路器-circuit-breaker-配置"><a href="#断路器-circuit-breaker-配置" class="headerlink" title="断路器(circuit breaker)配置"></a>断路器(circuit breaker)配置</h4><p>断路器配置用于控制<code>HystrixCircuitBreaker</code>实例的行为。</p>
<h5 id="是否启用断路器"><a href="#是否启用断路器" class="headerlink" title="是否启用断路器"></a>是否启用断路器</h5><ul>
<li><strong>circuitBreaker.enabled</strong></li>
</ul>
<p>此属性确定断路器是否用于跟踪健康状况，以及当断路器打开的时候是否用于短路请求(使请求快速失败进入降级逻辑)。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>true</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>false</code>、<code>true</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.circuitBreaker.enabled</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].circuitBreaker.enabled</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="断路器请求量阈值"><a href="#断路器请求量阈值" class="headerlink" title="断路器请求量阈值"></a>断路器请求量阈值</h5><ul>
<li><strong>circuitBreaker.requestVolumeThreshold</strong></li>
</ul>
<p>此属性设置将使断路器打开的滑动窗口中的最小请求数量。</p>
<p>例如，如果值是20，那么如果在滑动窗口中只接收到19个请求(比如一个10秒的窗口)，即使所有19个请求都失败了，断路器也不会打开。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>20</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.circuitBreaker.requestVolumeThreshold</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].circuitBreaker.requestVolumeThreshold</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值，如果部分接口不能容忍默认阈值可以单独配置</td>
</tr>
</tbody></table>
<h5 id="断路器等待窗口时间"><a href="#断路器等待窗口时间" class="headerlink" title="断路器等待窗口时间"></a>断路器等待窗口时间</h5><ul>
<li><strong>circuitBreaker.sleepWindowInMilliseconds</strong></li>
</ul>
<p>此属性设置断路器打开后拒绝请求的时间量，每隔一段时间(<code>sleepWindowInMilliseconds</code>，单位是毫秒)允许再次尝试(也就是放行一个请求)确定是否应该关闭断路器。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>5000</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].circuitBreaker.sleepWindowInMilliseconds</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="断路器错误百分比阈值"><a href="#断路器错误百分比阈值" class="headerlink" title="断路器错误百分比阈值"></a>断路器错误百分比阈值</h5><ul>
<li><strong>circuitBreaker.errorThresholdPercentage</strong></li>
</ul>
<p>此属性设置一个错误百分比，当请求错误率超过设定值，断路器就会打开。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>50</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.circuitBreaker.errorThresholdPercentage</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].circuitBreaker.errorThresholdPercentage</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<p>注意：</p>
<ul>
<li>配置项<code>circuitBreaker.requestVolumeThreshold</code>针对错误请求数量。</li>
<li>配置项<code>circuitBreaker.errorThresholdPercentage</code>针对错误请求百分比。</li>
</ul>
<h5 id="是否强制打开断路器"><a href="#是否强制打开断路器" class="headerlink" title="是否强制打开断路器"></a>是否强制打开断路器</h5><ul>
<li><strong>circuitBreaker.forceOpen</strong></li>
</ul>
<p>此属性控制断路器是否强制打开，强制打开断路器会使所有请求直接进入降级逻辑，也就是包裹在<code>HystrixCommand#run()</code>的逻辑不会执行。<code>circuitBreaker.forceOpen</code>属性和<code>circuitBreaker.forceClosed</code>属性互斥。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>false</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>false</code>、<code>true</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.circuitBreaker.forceOpen</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].circuitBreaker.forceOpen</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="是否强制关闭断路器"><a href="#是否强制关闭断路器" class="headerlink" title="是否强制关闭断路器"></a>是否强制关闭断路器</h5><ul>
<li><strong>circuitBreaker.forceClosed</strong></li>
</ul>
<p>此属性控制断路器是否强制关闭，强制关闭断路器会导致所有和断路器相关的配置和功能都失效，<code>HystrixCommand#run()</code>抛出异常会正常进入降级逻辑。<code>circuitBreaker.forceClosed</code>属性和<code>circuitBreaker.forceOpen</code>属性互斥。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>false</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>false</code>、<code>true</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.circuitBreaker.forceClosed</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].circuitBreaker.forceClosed</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<hr>
<h4 id="度量统计-metrics-配置"><a href="#度量统计-metrics-配置" class="headerlink" title="度量统计(metrics)配置"></a>度量统计(metrics)配置</h4><p>度量统计配置会对<code>HystrixCommand</code>或者<code>HystrixObservableCommand</code>执行时候的统计数据收集动作生效。</p>
<h5 id="滑动窗口持续时间"><a href="#滑动窗口持续时间" class="headerlink" title="滑动窗口持续时间"></a>滑动窗口持续时间</h5><ul>
<li><strong>metrics.rollingStats.timeInMilliseconds</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>10000</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.metrics.rollingStats.timeInMilliseconds</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].metrics.rollingStats.timeInMilliseconds</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="滑动窗口Bucket总数"><a href="#滑动窗口Bucket总数" class="headerlink" title="滑动窗口Bucket总数"></a>滑动窗口Bucket总数</h5><ul>
<li><strong>metrics.rollingStats.numBuckets</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>10</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">需要满足<code>metrics.rollingStats.timeInMilliseconds % metrics.rollingStats.numBuckets == 0</code>，要尽量小，否则有可能影响性能</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.metrics.rollingStats.numBuckets</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].metrics.rollingStats.numBuckets</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="是否启用百分数计算"><a href="#是否启用百分数计算" class="headerlink" title="是否启用百分数计算"></a>是否启用百分数计算</h5><ul>
<li><strong>metrics.rollingPercentile.enabled</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>true</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>true</code>、<code>false</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.metrics.rollingPercentile.enabled</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].metrics.rollingPercentile.enabled</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="百分数计算使用的滑动窗口持续时间"><a href="#百分数计算使用的滑动窗口持续时间" class="headerlink" title="百分数计算使用的滑动窗口持续时间"></a>百分数计算使用的滑动窗口持续时间</h5><ul>
<li><strong>metrics.rollingPercentile.timeInMilliseconds</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>60000</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].metrics.rollingPercentile.timeInMilliseconds</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="百分数计算使用的Bucket总数"><a href="#百分数计算使用的Bucket总数" class="headerlink" title="百分数计算使用的Bucket总数"></a>百分数计算使用的Bucket总数</h5><ul>
<li><strong>metrics.rollingPercentile.numBuckets</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>6</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">满足<code>metrics.rollingPercentile.timeInMilliseconds % metrics.rollingPercentile.numBuckets == 0</code>，要尽量小，否则有可能影响性能</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.metrics.rollingPercentile.numBuckets</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].metrics.rollingPercentile.numBuckets</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="百分数计算使用的Bucket容量"><a href="#百分数计算使用的Bucket容量" class="headerlink" title="百分数计算使用的Bucket容量"></a>百分数计算使用的Bucket容量</h5><ul>
<li><strong>metrics.rollingPercentile.bucketSize</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>100</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.metrics.rollingPercentile.bucketSize</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].metrics.rollingPercentile.bucketSize</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="健康状态快照收集的周期"><a href="#健康状态快照收集的周期" class="headerlink" title="健康状态快照收集的周期"></a>健康状态快照收集的周期</h5><ul>
<li><strong>metrics.healthSnapshot.intervalInMilliseconds</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>500</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].metrics.healthSnapshot.intervalInMilliseconds</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<hr>
<h4 id="请求上下文配置"><a href="#请求上下文配置" class="headerlink" title="请求上下文配置"></a>请求上下文配置</h4><p>请求上下文属性主要涉及到<code>HystrixRequestContext</code>和<code>HystrixCommand</code>的使用。</p>
<h5 id="是否启用请求缓存"><a href="#是否启用请求缓存" class="headerlink" title="是否启用请求缓存"></a>是否启用请求缓存</h5><ul>
<li><strong>requestCache.enabled</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>true</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>true</code>、<code>false</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.requestCache.enabled</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].requestCache.enabled</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h5 id="是否启用请求日志"><a href="#是否启用请求日志" class="headerlink" title="是否启用请求日志"></a>是否启用请求日志</h5><ul>
<li><strong>requestLog.enabled</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>true</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>true</code>、<code>false</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.command.default.requestLog.enabled</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.command.[HystrixCommandKey].requestLog.enabled</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h3 id="请求合成器配置-Collapser-Properties"><a href="#请求合成器配置-Collapser-Properties" class="headerlink" title="请求合成器配置(Collapser Properties)"></a>请求合成器配置(Collapser Properties)</h3><p>请求合成器配置主要控制<code>HystrixCollapser</code>的行为。</p>
<h4 id="请求合成的最大批次量"><a href="#请求合成的最大批次量" class="headerlink" title="请求合成的最大批次量"></a>请求合成的最大批次量</h4><ul>
<li><strong>maxRequestsInBatch</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>Integer.MAX_VALUE</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.collapser.default.maxRequestsInBatch</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.collapser.[HystrixCollapserKey].maxRequestsInBatch</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h4 id="延迟执行时间"><a href="#延迟执行时间" class="headerlink" title="延迟执行时间"></a>延迟执行时间</h4><ul>
<li><strong>timerDelayInMilliseconds</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>10</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.collapser.default.timerDelayInMilliseconds</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.collapser.[HystrixCollapserKey].timerDelayInMilliseconds</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<h4 id="是否启用请求合成缓存"><a href="#是否启用请求合成缓存" class="headerlink" title="是否启用请求合成缓存"></a>是否启用请求合成缓存</h4><ul>
<li><strong>requestCache.enabled</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>true</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>true</code>、<code>false</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.collapser.default.requestCache.enabled</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.collapser.[HystrixCollapserKey].requestCache.enabled</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议保持默认值</td>
</tr>
</tbody></table>
<hr>
<h3 id="线程池配置"><a href="#线程池配置" class="headerlink" title="线程池配置"></a>线程池配置</h3><p><code>Hystrix</code>使用的是<code>JUC</code>线程池<code>ThreadPoolExecutor</code>，线程池相关配置直接影响<code>ThreadPoolExecutor</code>实例。<code>Hystrix</code>的命令执行选用了线程池策略，那么就是通过线程池隔离执行的，最好为每一个分组设立独立的线程池。笔者在生产实践的时候，一般把<code>HystrixCommandGroupKey</code>和<code>HystrixThreadPoolKey</code>设置为一致。</p>
<h4 id="核心线程数"><a href="#核心线程数" class="headerlink" title="核心线程数"></a>核心线程数</h4><ul>
<li><strong>coreSize</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>10</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.threadpool.default.coreSize</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.threadpool.[HystrixThreadPoolKey].coreSize</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">根据真实情况自行配置和调整</td>
</tr>
</tbody></table>
<h4 id="最大线程数"><a href="#最大线程数" class="headerlink" title="最大线程数"></a>最大线程数</h4><ul>
<li><strong>maximumSize</strong></li>
</ul>
<p>此属性只有在<code>allowMaximumSizeToDivergeFromCoreSize</code>为<code>true</code>的时候才生效。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>10</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.threadpool.default.maximumSize</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.threadpool.[HystrixThreadPoolKey].maximumSize</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">根据真实情况自行配置和调整</td>
</tr>
</tbody></table>
<h4 id="最大任务队列容量"><a href="#最大任务队列容量" class="headerlink" title="最大任务队列容量"></a>最大任务队列容量</h4><ul>
<li><strong>maxQueueSize</strong></li>
</ul>
<p>此属性配置为-1时使用的是<code>SynchronousQueue</code>，配置为大于1的整数时使用的是<code>LinkedBlockingQueue</code>。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>-1</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>-1</code>或者大于0的整数</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.threadpool.default.maxQueueSize</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.threadpool.[HystrixThreadPoolKey].maxQueueSize</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">根据真实情况自行配置和调整</td>
</tr>
</tbody></table>
<h4 id="任务拒绝的任务队列阈值"><a href="#任务拒绝的任务队列阈值" class="headerlink" title="任务拒绝的任务队列阈值"></a>任务拒绝的任务队列阈值</h4><ul>
<li><strong>queueSizeRejectionThreshold</strong></li>
</ul>
<p>当<code>maxQueueSize</code>配置为-1的时候，此配置项不生效。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>5</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">大于0的整数</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.threadpool.default.queueSizeRejectionThreshold</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.threadpool.[HystrixThreadPoolKey].queueSizeRejectionThreshold</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">根据真实情况自行配置和调整</td>
</tr>
</tbody></table>
<h4 id="非核心线程存活时间"><a href="#非核心线程存活时间" class="headerlink" title="非核心线程存活时间"></a>非核心线程存活时间</h4><ul>
<li><strong>keepAliveTimeMinutes</strong></li>
</ul>
<p>当<code>allowMaximumSizeToDivergeFromCoreSize</code>为<code>true</code>并且<code>maximumSize</code>大于<code>coreSize</code>时此配置才生效。</p>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>1</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">大于0的整数</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.threadpool.default.keepAliveTimeMinutes</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.threadpool.[HystrixThreadPoolKey].keepAliveTimeMinutes</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">根据真实情况自行配置和调整</td>
</tr>
</tbody></table>
<h4 id="是否允许最大线程数生效"><a href="#是否允许最大线程数生效" class="headerlink" title="是否允许最大线程数生效"></a>是否允许最大线程数生效</h4><ul>
<li><strong>allowMaximumSizeToDivergeFromCoreSize</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>false</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center"><code>true</code>、<code>false</code></td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.threadpool.default.allowMaximumSizeToDivergeFromCoreSize</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.threadpool.[HystrixThreadPoolKey].allowMaximumSizeToDivergeFromCoreSize</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">根据真实情况自行配置和调整</td>
</tr>
</tbody></table>
<h4 id="线程池滑动窗口持续时间"><a href="#线程池滑动窗口持续时间" class="headerlink" title="线程池滑动窗口持续时间"></a>线程池滑动窗口持续时间</h4><ul>
<li><strong>metrics.rollingStats.timeInMilliseconds</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>10000</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.threadpool.default.metrics.rollingStats.timeInMilliseconds</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.threadpool.[HystrixThreadPoolKey].metrics.rollingStats.timeInMilliseconds</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议使用默认值</td>
</tr>
</tbody></table>
<h4 id="线程池滑动窗口Bucket总数"><a href="#线程池滑动窗口Bucket总数" class="headerlink" title="线程池滑动窗口Bucket总数"></a>线程池滑动窗口Bucket总数</h4><ul>
<li><strong>metrics.rollingStats.numBuckets</strong></li>
</ul>
<table>
<thead>
<tr>
<th align="center">项</th>
<th align="center">值</th>
</tr>
</thead>
<tbody><tr>
<td align="center">默认值</td>
<td align="center"><code>10</code></td>
</tr>
<tr>
<td align="center">可选值</td>
<td align="center">满足<code>metrics.rollingStats.timeInMilliseconds % metrics.rollingStats.numBuckets == 0</code>，值要尽量少，否则会影响性能</td>
</tr>
<tr>
<td align="center">默认全局配置</td>
<td align="center"><code>hystrix.threadpool.default.metrics.rollingStats.numBuckets</code></td>
</tr>
<tr>
<td align="center">实例配置</td>
<td align="center"><code>hystrix.threadpool.[HystrixThreadPoolKey].metrics.rollingStats.numBuckets</code></td>
</tr>
<tr>
<td align="center">建议(笔者备注)</td>
<td align="center">建议使用默认值</td>
</tr>
</tbody></table>
<h2 id="Hystrix工作流程"><a href="#Hystrix工作流程" class="headerlink" title="Hystrix工作流程"></a><code>Hystrix</code>工作流程</h2><p><strong>官网图例</strong></p>
<p>下图显示<code>HystrixCommand</code>或<code>HystrixObservableCommand</code>如何与<code>HystrixCircuitBreaker</code>及其逻辑和决策流程交互，包括计数器在断路器中的行为。<img src="https://img-blog.csdn.net/20171114223525259?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvaHJ5MjAxNQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/4/16e33f9015696d70~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp" alt="file"></p>
<p>首先我们看一下上方的这张图，这个图完整的描述了<code>Hystrix</code>的工作流程：</p>
<ol>
<li>每次调用都会创建一个<code>HystrixCommand</code></li>
<li>执行<code>execute</code>或是<code>queue</code>做同步异步调用</li>
<li>查看启用缓存，是缓存击中返回缓存中的响应结果，否则进入步骤4</li>
<li>判断熔断器是否打开，如果打开跳到步骤9，否则进入步骤5</li>
<li>判断线程池&#x2F;信号量是否饱满，如果跑满进入步骤9，否则进入步骤6</li>
<li>调用<code>HystrixCommand</code>的run方法，如果调用超时进入步骤9</li>
<li>判断是否调用成功，返回成功调用结构，如果失败进入步骤9</li>
<li>计算熔断器状态，，所有的运行状态(成功，失败，拒绝，超时)上报给熔断器，用于统计从而判断熔断器状态</li>
<li>降级处理逻辑</li>
<li>返回执行结果</li>
</ol>
<h2 id="服务监控HystrixDashBoard"><a href="#服务监控HystrixDashBoard" class="headerlink" title="服务监控HystrixDashBoard"></a>服务监控HystrixDashBoard</h2><p>除了隔离依赖服务的调用以外，<code>Hystrix</code>还提供了<strong>准实时的服务调用监控（<code>Hystrix Dashboard</code>）</strong>，<code>Hystrix</code>会持续地记录所有通过<code>Hystrix</code>发起的请求的执行信息，并以统计报表和图形的心是展示给用户，包括每秒执行多少请求多少成功，多少失败等。<code>Netflix</code>通过<code>hystrix-metricx-event-stream</code>项目实现了对以上指标的监控。Spring Cloud也提供了Hystrix Dashboard的整合，对监控内容转化成可视化界面。</p>
<ol>
<li><p>创建工程<code>cloud-consuemr-hystrix-dashboard9001</code></p>
</li>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Cloud-06-Hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-consuemr-hystrix-dashboard9001<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>application.yml</code>配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>主启动类<code>HystrixDashboardMain9001</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span> <span class="comment">//启动监控图形化界面的关键注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HystrixDashboardMain9001</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HystrixDashboardMain9001.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要被监控的服务都必须依赖这个包<code>spring-boot-starter-actuator</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--actuator监控信息完善--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动工程</p>
<p>访问如下网址<code>http://localhost:9001/hystrix</code> 出现以下界面表示成功。</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727230836837.png" alt="image-20220727230836837"></p>
</li>
</ol>
<h2 id="Hystrix监控演示"><a href="#Hystrix监控演示" class="headerlink" title="Hystrix监控演示"></a>Hystrix监控演示</h2><p>被监控的服务不仅要添加<code>spring-boot-starter-actuator</code>依赖</p>
<p>还需要再主启动类中新增配置</p>
<p>还需要再<code>application.yml</code>中配置如下</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 暴露hystrix端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;hystrix.stream&#x27;</span></span><br></pre></td></tr></table></figure>

<p>重启服务端点</p>
<p>启动监控</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727233259435.png" alt="image-20220727233259435"></p>
<p>参数配置</p>
<p>在<code>Hystrix Dashboard</code>中输入服务暴露的<code>hystrix</code>流地址<code>http://ip地址:端口/actuator/hystrix.stream</code></p>
<p>Delay：获取信息的频率</p>
<p>Title：名称</p>
<p><strong>监控界面 可以观察到线程池的情况、断路器的开闭、服务调用的失败率等。</strong></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727233924501.png" alt="image-20220727233924501"></p>
<p>实心圆：共有两种含义。它通过颜色的变化代表了实例的监控程度，它的健康度从 <strong>绿色&lt;黄色&lt;橙色&lt;红色 递减。</strong></p>
<p>该实心圆除了颜色的变化之外，它的大小也会根据实例的请求流量发生改变，流量越大该实现圆就越大。所以通过该实心圆的展示，就可以再大量的实例中快速的发现<strong>故障实例和高压力实例</strong>。</p>
<p>曲线：用来记录两分钟内流量的相对变化，可以通过它来观察到流量的上升和下降趋势。</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727234546737.png" alt="image-20220727234546737"></p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220727234628283.png" alt="image-20220727234628283"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Devil</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://devildyw.github.io/2022/07/26/Spring%20Cloud-Hystrix/">https://devildyw.github.io/2022/07/26/Spring%20Cloud-Hystrix/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://devildyw.github.io" target="_blank">Devil的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring-Cloud/">Spring Cloud</a></div><div class="post_share"><div class="social-share" data-image="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-k7zdqm.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/27/Spring%20Cloud-Gateway/"><img class="prev-cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-6omo76.jpg" onerror="onerror=null;src='https://tva1.sinaimg.cn/large/832afe33ly1gbi8718jtpg20r00lc776.gif'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring Cloud-Gateway</div></div></a></div><div class="next-post pull-right"><a href="/2022/07/24/Spring%20Cloud-OpenFeign/"><img class="next-cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-g7qjr3.jpg" onerror="onerror=null;src='https://tva1.sinaimg.cn/large/832afe33ly1gbi8718jtpg20r00lc776.gif'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring Cloud-OpenFeign</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/07/14/Spring%20Cloud-Zookeeper/" title="Spring Cloud-Zookeeper"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/tag.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-14</div><div class="title">Spring Cloud-Zookeeper</div></div></a></div><div><a href="/2022/07/12/Spring%20Cloud/" title="Spring Cloud"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-z8pyxo.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-12</div><div class="title">Spring Cloud</div></div></a></div><div><a href="/2022/07/23/Spring%20Cloud-Consul/" title="Spring Cloud-Consul"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-57kw88.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-23</div><div class="title">Spring Cloud-Consul</div></div></a></div><div><a href="/2022/07/24/Spring%20Cloud-Ribbon/" title="Spring Cloud-Ribbon"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-v9orm5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-24</div><div class="title">Spring Cloud-Ribbon</div></div></a></div><div><a href="/2022/07/24/Spring%20Cloud-OpenFeign/" title="Spring Cloud-OpenFeign"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-g7qjr3.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-24</div><div class="title">Spring Cloud-OpenFeign</div></div></a></div><div><a href="/2022/07/27/Spring%20Cloud-Gateway/" title="Spring Cloud-Gateway"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-6omo76.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-27</div><div class="title">Spring Cloud-Gateway</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Cloud-Hystrix"><span class="toc-number">1.</span> <span class="toc-text">Spring Cloud-Hystrix</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%9B%AA%E5%B4%A9"><span class="toc-number">1.1.1.</span> <span class="toc-text">服务雪崩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">1.3.</span> <span class="toc-text">服务熔断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">1.4.</span> <span class="toc-text">服务降级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81"><span class="toc-number">1.5.</span> <span class="toc-text">服务限流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">1.6.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E7%88%B6%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.6.1.</span> <span class="toc-text">新建父工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90%E5%B7%A5%E7%A8%8B%E2%80%93%E6%9C%8D%E5%8A%A1%E7%94%9F%E4%BA%A7%E8%80%85"><span class="toc-number">1.6.2.</span> <span class="toc-text">创建子工程–服务生产者</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JMeter%E9%AB%98%E5%B9%B6%E5%8F%91%E6%B5%8B%E5%8E%8B"><span class="toc-number">1.7.</span> <span class="toc-text">JMeter高并发测压</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">1.7.1.</span> <span class="toc-text">结论</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90%E5%B7%A5%E7%A8%8B%E2%80%93%E6%9C%8D%E5%8A%A1%E6%B6%88%E8%B4%B9%E8%80%85"><span class="toc-number">1.8.</span> <span class="toc-text">创建子工程–服务消费者</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3"><span class="toc-number">1.9.</span> <span class="toc-text">解决</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7-1"><span class="toc-number">1.10.</span> <span class="toc-text">服务降级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E8%80%85%E9%99%8D%E7%BA%A7%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.10.1.</span> <span class="toc-text">生产者降级保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E9%99%8D%E7%BA%A7%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.10.2.</span> <span class="toc-text">消费者降级保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">1.10.3.</span> <span class="toc-text">全局服务降级配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E8%80%A6"><span class="toc-number">1.10.4.</span> <span class="toc-text">解耦</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD-1"><span class="toc-number">1.11.</span> <span class="toc-text">服务熔断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D"><span class="toc-number">1.11.1.</span> <span class="toc-text">实操</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.12.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E5%9C%A8%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E8%B5%B7%E4%BD%9C%E7%94%A8"><span class="toc-number">1.12.1.</span> <span class="toc-text">断路器在什么情况下起作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E5%BC%80%E5%90%AF%E6%88%96%E5%85%B3%E9%97%AD%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.12.2.</span> <span class="toc-text">断路器开启或关闭的条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E6%89%93%E5%BC%80%E4%B9%8B%E5%90%8E"><span class="toc-number">1.12.3.</span> <span class="toc-text">断路器打开之后</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">1.13.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Command-Properties%EF%BC%88%E6%8C%87%E4%BB%A4%E5%8F%82%E6%95%B0%EF%BC%89"><span class="toc-number">1.13.1.</span> <span class="toc-text">Command Properties（指令参数）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Execution%EF%BC%88%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-number">1.13.1.1.</span> <span class="toc-text">Execution（执行）</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5"><span class="toc-number">1.13.1.1.1.</span> <span class="toc-text">隔离策略</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%85%81%E8%AE%B8%E8%B6%85%E6%97%B6"><span class="toc-number">1.13.1.1.2.</span> <span class="toc-text">是否允许超时</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4%E4%B8%8A%E9%99%90"><span class="toc-number">1.13.1.1.3.</span> <span class="toc-text">超时时间上限</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%98%AF%E5%90%A6%E4%B8%AD%E6%96%AD"><span class="toc-number">1.13.1.1.4.</span> <span class="toc-text">超时是否中断</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E6%98%AF%E5%90%A6%E4%B8%AD%E6%96%AD"><span class="toc-number">1.13.1.1.5.</span> <span class="toc-text">取消是否中断</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%80%E5%A4%A7%E5%B9%B6%E5%8F%91%E8%AF%B7%E6%B1%82%E4%B8%8A%E9%99%90-SEMAPHORE"><span class="toc-number">1.13.1.1.6.</span> <span class="toc-text">最大并发请求上限(SEMAPHORE)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E9%99%8D%E7%BA%A7-fallback-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.13.1.2.</span> <span class="toc-text">命令降级(fallback)配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%80%E5%A4%A7%E5%B9%B6%E5%8F%91%E9%99%8D%E7%BA%A7%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E4%B8%8A%E9%99%90"><span class="toc-number">1.13.1.2.1.</span> <span class="toc-text">最大并发降级请求处理上限</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%BC%80%E5%90%AF%E9%99%8D%E7%BA%A7"><span class="toc-number">1.13.1.2.2.</span> <span class="toc-text">是否开启降级</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8-circuit-breaker-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.13.1.3.</span> <span class="toc-text">断路器(circuit breaker)配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%90%AF%E7%94%A8%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="toc-number">1.13.1.3.1.</span> <span class="toc-text">是否启用断路器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E8%AF%B7%E6%B1%82%E9%87%8F%E9%98%88%E5%80%BC"><span class="toc-number">1.13.1.3.2.</span> <span class="toc-text">断路器请求量阈值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E7%AD%89%E5%BE%85%E7%AA%97%E5%8F%A3%E6%97%B6%E9%97%B4"><span class="toc-number">1.13.1.3.3.</span> <span class="toc-text">断路器等待窗口时间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E9%94%99%E8%AF%AF%E7%99%BE%E5%88%86%E6%AF%94%E9%98%88%E5%80%BC"><span class="toc-number">1.13.1.3.4.</span> <span class="toc-text">断路器错误百分比阈值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%BC%BA%E5%88%B6%E6%89%93%E5%BC%80%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="toc-number">1.13.1.3.5.</span> <span class="toc-text">是否强制打开断路器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%BC%BA%E5%88%B6%E5%85%B3%E9%97%AD%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="toc-number">1.13.1.3.6.</span> <span class="toc-text">是否强制关闭断路器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%A6%E9%87%8F%E7%BB%9F%E8%AE%A1-metrics-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.13.1.4.</span> <span class="toc-text">度量统计(metrics)配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%8C%81%E7%BB%AD%E6%97%B6%E9%97%B4"><span class="toc-number">1.13.1.4.1.</span> <span class="toc-text">滑动窗口持续时间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3Bucket%E6%80%BB%E6%95%B0"><span class="toc-number">1.13.1.4.2.</span> <span class="toc-text">滑动窗口Bucket总数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%90%AF%E7%94%A8%E7%99%BE%E5%88%86%E6%95%B0%E8%AE%A1%E7%AE%97"><span class="toc-number">1.13.1.4.3.</span> <span class="toc-text">是否启用百分数计算</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BE%E5%88%86%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BD%BF%E7%94%A8%E7%9A%84%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%8C%81%E7%BB%AD%E6%97%B6%E9%97%B4"><span class="toc-number">1.13.1.4.4.</span> <span class="toc-text">百分数计算使用的滑动窗口持续时间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BE%E5%88%86%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BD%BF%E7%94%A8%E7%9A%84Bucket%E6%80%BB%E6%95%B0"><span class="toc-number">1.13.1.4.5.</span> <span class="toc-text">百分数计算使用的Bucket总数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BE%E5%88%86%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BD%BF%E7%94%A8%E7%9A%84Bucket%E5%AE%B9%E9%87%8F"><span class="toc-number">1.13.1.4.6.</span> <span class="toc-text">百分数计算使用的Bucket容量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81%E5%BF%AB%E7%85%A7%E6%94%B6%E9%9B%86%E7%9A%84%E5%91%A8%E6%9C%9F"><span class="toc-number">1.13.1.4.7.</span> <span class="toc-text">健康状态快照收集的周期</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E4%B8%8A%E4%B8%8B%E6%96%87%E9%85%8D%E7%BD%AE"><span class="toc-number">1.13.1.5.</span> <span class="toc-text">请求上下文配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%90%AF%E7%94%A8%E8%AF%B7%E6%B1%82%E7%BC%93%E5%AD%98"><span class="toc-number">1.13.1.5.1.</span> <span class="toc-text">是否启用请求缓存</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%90%AF%E7%94%A8%E8%AF%B7%E6%B1%82%E6%97%A5%E5%BF%97"><span class="toc-number">1.13.1.5.2.</span> <span class="toc-text">是否启用请求日志</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%90%88%E6%88%90%E5%99%A8%E9%85%8D%E7%BD%AE-Collapser-Properties"><span class="toc-number">1.13.2.</span> <span class="toc-text">请求合成器配置(Collapser Properties)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%90%88%E6%88%90%E7%9A%84%E6%9C%80%E5%A4%A7%E6%89%B9%E6%AC%A1%E9%87%8F"><span class="toc-number">1.13.2.1.</span> <span class="toc-text">请求合成的最大批次量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4"><span class="toc-number">1.13.2.2.</span> <span class="toc-text">延迟执行时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%90%AF%E7%94%A8%E8%AF%B7%E6%B1%82%E5%90%88%E6%88%90%E7%BC%93%E5%AD%98"><span class="toc-number">1.13.2.3.</span> <span class="toc-text">是否启用请求合成缓存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%85%8D%E7%BD%AE"><span class="toc-number">1.13.3.</span> <span class="toc-text">线程池配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E6%95%B0"><span class="toc-number">1.13.3.1.</span> <span class="toc-text">核心线程数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%A4%A7%E7%BA%BF%E7%A8%8B%E6%95%B0"><span class="toc-number">1.13.3.2.</span> <span class="toc-text">最大线程数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%A4%A7%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%E5%AE%B9%E9%87%8F"><span class="toc-number">1.13.3.3.</span> <span class="toc-text">最大任务队列容量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%8B%92%E7%BB%9D%E7%9A%84%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%E9%98%88%E5%80%BC"><span class="toc-number">1.13.3.4.</span> <span class="toc-text">任务拒绝的任务队列阈值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E5%AD%98%E6%B4%BB%E6%97%B6%E9%97%B4"><span class="toc-number">1.13.3.5.</span> <span class="toc-text">非核心线程存活时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E5%85%81%E8%AE%B8%E6%9C%80%E5%A4%A7%E7%BA%BF%E7%A8%8B%E6%95%B0%E7%94%9F%E6%95%88"><span class="toc-number">1.13.3.6.</span> <span class="toc-text">是否允许最大线程数生效</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%8C%81%E7%BB%AD%E6%97%B6%E9%97%B4"><span class="toc-number">1.13.3.7.</span> <span class="toc-text">线程池滑动窗口持续时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3Bucket%E6%80%BB%E6%95%B0"><span class="toc-number">1.13.3.8.</span> <span class="toc-text">线程池滑动窗口Bucket总数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hystrix%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.14.</span> <span class="toc-text">Hystrix工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7HystrixDashBoard"><span class="toc-number">1.15.</span> <span class="toc-text">服务监控HystrixDashBoard</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hystrix%E7%9B%91%E6%8E%A7%E6%BC%94%E7%A4%BA"><span class="toc-number">1.16.</span> <span class="toc-text">Hystrix监控演示</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Devil</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">无它,唯手熟尔</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>