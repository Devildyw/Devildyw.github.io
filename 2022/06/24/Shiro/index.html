<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Shiro | Devil的个人博客</title><meta name="keywords" content="Java"><meta name="author" content="Devil"><meta name="copyright" content="Devil"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Shiro简介 Apache Shiro是一个Java的一个安全(权限)框架。 Shiro可以非常容易的开发出足够好的应用，其不仅可以用在JavaSE环境，也可以用在JavaEE环境。 Shiro可以完成：认证、授权、加密、会话管理、与Web集成、缓存等。  Shiro的功能基本的功能点如下图所示：  Shiro 把 Shiro 开发团队称为“应用程序的四大基石”——身份验证，授权，会话管理和加密">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro">
<meta property="og:url" content="https://devildyw.github.io/2022/06/24/Shiro/index.html">
<meta property="og:site_name" content="Devil的个人博客">
<meta property="og:description" content="Shiro简介 Apache Shiro是一个Java的一个安全(权限)框架。 Shiro可以非常容易的开发出足够好的应用，其不仅可以用在JavaSE环境，也可以用在JavaEE环境。 Shiro可以完成：认证、授权、加密、会话管理、与Web集成、缓存等。  Shiro的功能基本的功能点如下图所示：  Shiro 把 Shiro 开发团队称为“应用程序的四大基石”——身份验证，授权，会话管理和加密">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-pk9eye.jpg">
<meta property="article:published_time" content="2022-06-24T12:14:25.000Z">
<meta property="article:modified_time" content="2022-07-02T12:02:26.072Z">
<meta property="article:author" content="Devil">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-pk9eye.jpg"><link rel="shortcut icon" href="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/favicon.png"><link rel="canonical" href="https://devildyw.github.io/2022/06/24/Shiro/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Shiro',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-07-02 20:02:26'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/dyw.css"><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="Devil的个人博客" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/avatar.png" onerror="onerror=null;src='https://tva1.sinaimg.cn/large/832afe33ly1gbi8718jtpg20r00lc776.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">57</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">16</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/myself/"><i class="fa-fw fa fa-id-card"></i><span> 自我介绍</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-pk9eye.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Devil的个人博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="/myself/"><i class="fa-fw fa fa-id-card"></i><span> 自我介绍</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Shiro</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-24T12:14:25.000Z" title="发表于 2022-06-24 20:14:25">2022-06-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-02T12:02:26.072Z" title="更新于 2022-07-02 20:02:26">2022-07-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AE%89%E5%85%A8%E6%A1%86%E6%9E%B6/">安全框架</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Shiro"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Shiro"><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li><strong>Apache Shiro</strong>是一个Java的一个安全(权限)框架。</li>
<li>Shiro可以非常容易的开发出足够好的应用，其不仅可以用在JavaSE环境，也可以用在JavaEE环境。</li>
<li>Shiro可以完成：认证、授权、加密、会话管理、与Web集成、缓存等。</li>
</ul>
<h2 id="Shiro的功能"><a href="#Shiro的功能" class="headerlink" title="Shiro的功能"></a>Shiro的功能</h2><p>基本的功能点如下图所示：</p>
<p><img src="https://www.docs4dev.com/images/apache-shiro/1.5.3/ShiroFeatures.png" alt="img"></p>
<p>Shiro 把 Shiro 开发团队称为“应用程序的四大基石”——身份验证，授权，会话管理和加密作为其目标。</p>
<ul>
<li><p><strong>Authentication</strong>：有时也简称为“登录”，这是一个证明用户是他们所说的他们是谁的行为。</p>
</li>
<li><p><strong>Authorization</strong>：访问控制的过程，也就是绝对“谁”去访问“什么”。</p>
</li>
<li><p><strong>Session</strong> <strong>Management</strong>：管理用户特定的会话，即使在非 Web 或 EJB 应用程序。</p>
</li>
<li><p><strong>Cryptography</strong>：通过使用加密算法保持数据安全同时易于使用。</p>
</li>
</ul>
<p>也提供了额外的功能来支持和加强在不同环境下所关注的方面，尤其是以下这些：</p>
<ul>
<li><p>Web Support：Shiro 的 web 支持的 API 能够轻松地帮助保护 Web 应用程序。</p>
</li>
<li><p>Caching：缓存是 Apache Shiro 中的第一层公民，来确保安全操作快速而又高效。</p>
</li>
<li><p>Concurrency：Apache Shiro 利用它的并发特性来支持多线程应用程序。</p>
</li>
<li><p>Testing：测试支持的存在来帮助你编写单元测试和集成测试，并确保你的能够如预期的一样安全。</p>
</li>
<li><p>“Run As”：一个允许用户假设为另一个用户身份（如果允许）的功能，有时候在管理脚本很有用。</p>
</li>
<li><p>“Remember Me”：在会话中记住用户的身份，所以他们只需要在强制时候登录。</p>
</li>
</ul>
<h2 id="Shiro架构"><a href="#Shiro架构" class="headerlink" title="Shiro架构"></a>Shiro架构</h2><p>从外部来看，即从应用程序的角度来观察如何使用Shiro完成工作：</p>
<p><img src="https://www.docs4dev.com/images/apache-shiro/1.5.3/ShiroBasicArchitecture.png" alt="img"></p>
<ul>
<li><strong>Subject</strong>：在我们的教程中已经提到，Subject 实质上是一个当前执行用户的特定的安全“视图”。鉴于”User” 一词通常意味着一个人，而一个 Subject 可以是一个人，但它还可以代表第三方服务，daemon account，cron job，或其他类似的任何东西——基本上是当前正与软件进行交互的任何东西。</li>
</ul>
<p>所有 Subject 实例都被绑定到（且这是必须的）一个 SecurityManager 上。当你与一个 Subject 交互时，那些交互作用转化为与 SecurityManager 交互的特定 subject 的交互作用。</p>
<ul>
<li><strong>SecurityManager</strong>：SecurityManager 是 Shiro 架构的心脏，并作为一种“保护伞”对象来协调内部的安全组件共同构成一个对象图。然而，一旦 SecurityManager 和它的内置对象图已经配置给一个应用程序，那么它单独留下来，且应用程序开发人员几乎使用他们所有的时间来处理 Subject API。</li>
</ul>
<p>我们稍后会更详细地讨论 SecurityManager，但重要的是要认识到，当你正与一个 Subject 进行交互时，实质上是幕后的 SecurityManager 处理所有繁重的 Subject 安全操作。这反映在上面的基本流程图。</p>
<ul>
<li><strong>Realms</strong>：Realms 担当 Shiro 和你的应用程序的安全数据之间的“桥梁”或“连接器”。当它实际上与安全相关的数据如用来执行身份验证（登录）及授权（访问控制）的用户帐户交互时，Shiro 从一个或多个为应用程序配置的 Realm 中寻找许多这样的东西。</li>
</ul>
<p>在这个意义上说，Realm 本质上是一个特定安全的 DAO：它封装了数据源的连接详细信息，使 Shiro 所需的相关的数据可用。当配置 Shiro 时，你必须指定至少一个 Realm 用来进行身份验证和&#x2F;或授权。SecurityManager 可能配置多个 Realms，但至少有一个是必须的。</p>
<p>Shiro 提供了立即可用的 Realms 来连接一些安全数据源（即目录），如LDAP，关系数据库（JDBC），文本配置源，像 INI 及属性文件，以及更多。你可以插入你自己的 Realm 实现来代表自定义的数据源，如果默认地Realm 不符合你的需求。</p>
<p>像其他内置组件一样，Shiro SecurityManager 控制Realms 是如何被用来获取安全和身份数据来代表 Subject 实例的。</p>
<h3 id="内部架构"><a href="#内部架构" class="headerlink" title="内部架构"></a>内部架构</h3><p><img src="https://www.docs4dev.com/images/apache-shiro/1.5.3/ShiroArchitecture.png" alt="img"></p>
<ul>
<li><strong>Subject</strong>(org.apache.shiro.subject.Subject)</li>
</ul>
<p>​        当前与软件进行交互的实体（用户，第三方服务，cron job，等等）的安全特定“视图”。</p>
<ul>
<li><strong>SecurityManager</strong>(org.apache.shiro.mgt.SecurityManager)</li>
</ul>
<p>​        如上所述，SecurityManager 是 Shiro 架构的心脏。它基本上是一个“保护伞”对象，协调其管理的组件以确保它们能够一起顺利的工作。它还管理每个应用程序用户的 Shiro 的视图，因此它知道如何执行每个用户的安全操作。</p>
<ul>
<li><strong>Authenticator</strong>(org.apache.shiro.authc.Authenticator)</li>
</ul>
<p>​        Authenticator 是一个对执行及对用户的身份验证（登录）尝试负责的组件。当一个用户尝试登录时，该逻辑被 Authenticator 执行。Authenticator 知道如何与一个或多个 Realm 协调来存储相关的用户&#x2F;帐户信息。从这些Realm 中获得的数据被用来验证用户的身份来保证用户确实是他们所说的他们是谁。</p>
<ul>
<li><strong>Authentication</strong> <strong>Strategy</strong>(org.apache.shiro.authc.pam.AuthenticationStrategy)</li>
</ul>
<p>​        如果不止一个 Realm 被配置，则 AuthenticationStrategy 将会协调这些 Realm 来决定身份认证尝试成功或失败下的条件（例如，如果一个 Realm 成功，而其他的均失败，是否该尝试成功？ 是否所有的 Realm 必须成功？或只有第一个成功即可？）。</p>
<ul>
<li><strong>Authorizer</strong>(org.apache.shiro.authz.Authorizer)</li>
</ul>
<p>​        Authorizer 是负责在应用程序中决定用户的访问控制的组件。它是一种最终判定用户是否被允许做某事的机制。与 Authenticator 相似，Authorizer 也知道如何协调多个后台数据源来访问角色恶化权限信息。Authorizer 使用 该信息来准确地决定用户是否被允许执行给定的动作。</p>
<ul>
<li><strong>SessionManager</strong>(org.apache.shiro.session.SessionManager)</li>
</ul>
<p>​        SessionManager 知道如何去创建及管理用户 Session 生命周期来为所有环境下的用户提供一个强健的 Session 体验。这在安全框架界是一个独有的特色——Shiro 拥有能够在任何环境下本地化管理用户 Session 的能力， 即使没有可用的 Web&#x2F;Servlet 或 EJB 容器，它将会使用它内置的企业级会话管理来提供同样的编程体验。SessionDAO 的存在允许任何数据源能够在持久会话中使用。</p>
<ul>
<li><strong>SessionDAO</strong>(org.apache.shiro.session.mgt.eis.SessionDAO)</li>
</ul>
<p>​        SesssionDAO 代表 SessionManager 执行 Session 持久化（CRUD）操作。这允许任何数据存储被插入到会话管理的基础之中。</p>
<ul>
<li><strong>CacheManager</strong>(org.apahce.shiro.cache.CacheManager)</li>
</ul>
<p>​        CacheManager 创建并管理其他 Shiro 组件使用的 Cache 实例生命周期。因为 Shiro 能够访问许多后台数据源， 由于身份验证，授权和会话管理，缓存在框架中一直是一流的架构功能，用来在同时使用这些数据源时提高 性能。任何现代开源和&#x2F;或企业的缓存产品能够被插入到 Shiro 来提供一个快速及高效的用户体验。</p>
<ul>
<li><strong>Cryptography</strong>(org.apache.shiro.crypto.*)</li>
</ul>
<p>​        Cryptography 是对企业安全框架的一个很自然的补充。Shiro 的crypto 包包含量易于使用和理解的cryptographic Ciphers，Hasher（又名 digests）以及不同的编码器实现的代表。所有在这个包中的类都被精心地设计以易于使用和易于理解。任何使用 Java 的本地密码支持的人都知道它可以是一个难以驯服的具有挑战性的动物。Shiro 的 cryptoAPI 简化了复杂的 Java 机制，并使加密对于普通人也易于使用。</p>
<ul>
<li><strong>Realms</strong>(org.apache.shiro.realm.Realm)</li>
</ul>
<p>​        如上所述，Realms 在 Shiro 和你的应用程序的安全数据之间担当“桥梁”或“连接器”。当它实际上与安全相关的数据如用来执行身份验证（登录）及授权（访问控制）的用户帐户交互时，Shiro 从一个或多个为应用程序配置的Realm 中寻找许多这样的东西。你可以按你的需要配置多个 Realm（通常一个数据源一个 Realm），且 Shiro 将为身份验证和授权对它们进行必要的协调。</p>
<h2 id="自定义Realm"><a href="#自定义Realm" class="headerlink" title="自定义Realm"></a>自定义Realm</h2><p>自定义<code>Realm</code>需要继承<code>AuthorizingRealm</code> 并且重写它的两个方法<code>AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals)</code>和<code>AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">principal</span> <span class="operator">=</span> (String) principals.getPrimaryPrincipal();</span><br><span class="line"></span><br><span class="line">        <span class="type">SimpleAuthorizationInfo</span> <span class="variable">authorizationInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">        <span class="comment">//通过我们写的方法将数据库关于该用户的信息全部查出</span></span><br><span class="line">        List&lt;String&gt; roles = userService.queryUserRoleByUsername(principal);</span><br><span class="line">        List&lt;String&gt; permissions = userService.queryUserPermissionByUsername(principal);</span><br><span class="line">		<span class="comment">//这里添加用户的角色权限信息</span></span><br><span class="line">        authorizationInfo.addRoles(roles);</span><br><span class="line">        authorizationInfo.addStringPermissions(permissions);</span><br><span class="line">        <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">principal</span> <span class="operator">=</span> (String) token.getPrincipal();</span><br><span class="line">        <span class="comment">//通过我们配置的数据源查询用户密码</span></span><br><span class="line">        <span class="comment">//这里主要查询用户的验证信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userService.queryUserPasswordByUsername(principal);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(password))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownAccountException</span>(<span class="string">&quot;账户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(principal,password,getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>密码肯定不能用明文存入数据库，所以我们要告诉后续的验证程序我们用的时什么加密算法。</p>
<p><code>AuthorizingRealm</code>提供了一个方法让我们指定Shiro框架采用什么加密算法对传入的token中的密码信息进行加密后与数据库中的密文密码进行验证。</p>
<p>指定的方式有三种</p>
<ol>
<li><p>自定Realm的构造方法中指定</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserRealm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//调用AuthorizingRealm提供的方法</span></span><br><span class="line">        setCredentialsMatcher(<span class="keyword">new</span> <span class="title class_">HashedCredentialsMatcher</span>(<span class="string">&quot;MD5&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略下方重写方法了</span></span><br><span class="line"> 	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为我们在ShiroConfig中会手动创建Bean在加入到IOC容器中所以在构造方法中调用<code>setCredentialsMatcher</code>是可行的。</p>
</li>
<li><p>在ShiroConfig中 创建了自定义Realm后在调用<code>setCredentialsMatcher</code>方法指定</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> UserRealm <span class="title function_">userRealm</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">UserRealm</span> <span class="variable">userRealm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserRealm</span>();</span><br><span class="line">       userRealm.setCredentialsMatcher(<span class="keyword">new</span> <span class="title class_">HashedCredentialsMatcher</span>(<span class="string">&quot;MD5&quot;</span>));</span><br><span class="line">       <span class="keyword">return</span> userRealm;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>本身就是继承了<code>AuthorizingRealm</code>，所以父类的方法也都拥有。</p>
</li>
<li><p>自定手动在自定义Realm的内部编写一个方法 然后在其上添加注解<code>@PostConstruct</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@Description</span> 密码匹配器</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostConstruct</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initCredentialsMatcher</span><span class="params">()</span>&#123;</span><br><span class="line">       <span class="type">HashedCredentialsMatcher</span> <span class="variable">md5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashedCredentialsMatcher</span>(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">       <span class="comment">//设置提交的AuthenticationToken的凭据在与存储在系统中的凭据进行比较之前将被散列的次数。 根据用户注册是密码加密的次数的设置相映</span></span><br><span class="line">       md5.setHashIterations();</span><br><span class="line">       setCredentialsMatcher(md5);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>@PostConstruct</code></p>
<p>Java中该注解的说明：@PostConstruct该注解被用来修饰一个非静态的void（）方法。被@PostConstruct修饰的方法会在服务器加载<code>Servlet</code>的时候运行，并且只会被服务器执行一次。<code>@PostConstruct</code>在构造函数之后执行，<code>init（）</code>方法之前执行。</p>
</li>
</ol>
<hr>
<h2 id="常用API"><a href="#常用API" class="headerlink" title="常用API"></a>常用API</h2><h3 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a><code>Subject</code></h3><table>
<thead>
<tr>
<th>Subject 登录相关方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>isAuthenticated()</td>
<td>返回true 表示已经登录，否则返回false。</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Subject 角色相关方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>hasRole(String roleName)</td>
<td>返回true 如果Subject 被分配了指定的角色，否则返回false。</td>
</tr>
<tr>
<td>hasRoles(List<String> roleNames)</td>
<td>返回true 如果Subject 被分配了所有指定的角色，否则返回false。</td>
</tr>
<tr>
<td>hasAllRoles(Collection<String>roleNames)</td>
<td>返回一个与方法参数中目录一致的hasRole 结果的集合。有性能的提高如果许多角色需要执行检查（例如，当自定义一个复杂的视图）。</td>
</tr>
<tr>
<td>checkRole(String roleName)</td>
<td>安静地返回，如果Subject 被分配了指定的角色，不然的话就抛出AuthorizationException。</td>
</tr>
<tr>
<td>checkRoles(Collection<String>roleNames)</td>
<td>安静地返回，如果Subject 被分配了所有的指定的角色，不然的话就抛出AuthorizationException。</td>
</tr>
<tr>
<td>checkRoles(String… roleNames)</td>
<td>与上面的checkRoles 方法的效果相同，但允许Java5 的var-args 类型的参数</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Subject 资源相关方法</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>isPermitted(Permission p)</td>
<td>返回true 如果该Subject 被允许执行某动作或访问被权限实例指定的资源，否则返回false</td>
</tr>
<tr>
<td>isPermitted(List<Permission> perms)</td>
<td>返回一个与方法参数中目录一致的isPermitted 结果的集合。</td>
</tr>
<tr>
<td>isPermittedAll(Collection<Permission>perms)</td>
<td>返回true 如果该Subject 被允许所有指定的权限，否则返回false有性能的提高如果需要执行许多检查（例如，当自定义一个复杂的视图）</td>
</tr>
<tr>
<td>isPermitted(String perm)</td>
<td>返回true 如果该Subject 被允许执行某动作或访问被字符串权限指定的资源，否则返回false。</td>
</tr>
<tr>
<td>isPermitted(String…perms)</td>
<td>返回一个与方法参数中目录一致的isPermitted 结果的数组。有性能的提高如果许多字符串权限检查需要被执行（例如，当自定义一个复杂的视图）。</td>
</tr>
<tr>
<td>isPermittedAll(String…perms)</td>
<td>返回true 如果该Subject 被允许所有指定的字符串权限，否则返回false。</td>
</tr>
<tr>
<td>checkPermission(Permission p)</td>
<td>安静地返回，如果Subject 被允许执行某动作或访问被特定的权限实例指定的资源，不然的话就抛出AuthorizationException 异常。</td>
</tr>
<tr>
<td>checkPermission(String perm)</td>
<td>安静地返回，如果Subject 被允许执行某动作或访问被特定的字符串权限指定的资源，不然的话就抛出AuthorizationException 异常。</td>
</tr>
<tr>
<td>checkPermissions(Collection<Permission> perms)</td>
<td>安静地返回，如果Subject 被允许所有的权限，不然的话就抛出AuthorizationException 异常。有性能的提高如果需要执行许多检查（例如，当自定义一个复杂的视图）</td>
</tr>
<tr>
<td>checkPermissions(String… perms)</td>
<td>和上面的checkPermissions 方法效果相同，但是使用的是基于字符串的权限。</td>
</tr>
</tbody></table>
<hr>
<h2 id="Web项目下Shiro内置的过滤器"><a href="#Web项目下Shiro内置的过滤器" class="headerlink" title="Web项目下Shiro内置的过滤器"></a>Web项目下Shiro内置的过滤器</h2><p>拦截器对应的不同功能。</p>
<table>
<thead>
<tr>
<th>过滤器</th>
<th>过滤器类</th>
<th>说明</th>
<th>默认</th>
</tr>
</thead>
<tbody><tr>
<td><strong>authc</strong></td>
<td><strong>FormAuthenticationFilter</strong></td>
<td><strong>基于表单的过滤器；如“&#x2F;&#x3D;authc”，如果没有登录会跳到相应的登录页面登录</strong></td>
<td><strong>无</strong></td>
</tr>
<tr>
<td><strong>logout</strong></td>
<td><strong>LogoutFilter</strong></td>
<td><strong>退出过滤器，主要属性：redirectUrl：退出成功后重定向的地址，如“&#x2F;logout&#x3D;logout”</strong></td>
<td><strong>&#x2F;</strong></td>
</tr>
<tr>
<td><strong>anon</strong></td>
<td><strong>AnonymousFilter</strong></td>
<td><strong>匿名过滤器，即不需要登录即可访问；一般用于静态资源过滤；示例“&#x2F;static&#x2F;&#x3D;anon”</strong></td>
<td><strong>无</strong></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>过滤器</strong></th>
<th><strong>过滤器类</strong></th>
<th><strong>说明</strong></th>
<th><strong>默认</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>roles</strong></td>
<td><strong>RolesAuthorizationFilter</strong></td>
<td><strong>角色授权拦截器，验证用户是否拥有所有角色；主要属性： loginUrl：登录页面地址（&#x2F;login.jsp）；unauthorizedUrl：未授权后重定向的地址；示例“&#x2F;admin&#x2F;&#x3D;roles[admin]”</strong></td>
<td><strong>无</strong></td>
</tr>
<tr>
<td><strong>perms</strong></td>
<td><strong>PermissionsAuthorizationFilter</strong></td>
<td><strong>权限授权拦截器，验证用户是否拥有所有权限；属性和roles一样；示例“&#x2F;user&#x2F;&#x3D;perms[“user:create”]”</strong></td>
<td><strong>无</strong></td>
</tr>
<tr>
<td><strong>port</strong></td>
<td><strong>PortFilter</strong></td>
<td><strong>端口拦截器，主要属性：port（80）：可以通过的端口；示例“&#x2F;test&#x3D; port[80]”，如果用户访问该页面是非80，将自动将请求端口改为80并重定向到该80端口，其他路径&#x2F;参数等都一样</strong></td>
<td><strong>无</strong></td>
</tr>
<tr>
<td><strong>rest</strong></td>
<td><strong>HttpMethodPermissionFilter</strong></td>
<td><strong>rest风格拦截器，自动根据请求方法构建权限字符串（GET&#x3D;read, POST&#x3D;create,PUT&#x3D;update,DELETE&#x3D;delete,HEAD&#x3D;read,TRACE&#x3D;read,OPTIONS&#x3D;read, MKCOL&#x3D;create）构建权限字符串；示例“&#x2F;users&#x3D;rest[user]”，会自动拼出“user:read,user:create,user:update,user:delete”权限字符串进行权限匹配（所有都得匹配，isPermittedAll）</strong></td>
<td><strong>无</strong></td>
</tr>
<tr>
<td><strong>ssl</strong></td>
<td><strong>SslFilter</strong></td>
<td><strong>SSL拦截器，只有请求协议是https才能通过；否则自动跳转会https端口（443）；其他和port拦截器一样；</strong></td>
<td><strong>无</strong></td>
</tr>
</tbody></table>
<h2 id="自定义过滤器"><a href="#自定义过滤器" class="headerlink" title="自定义过滤器"></a>自定义过滤器</h2><p>自定义过滤器需要继承<code>AuthorizationFilter</code>并重写它的<code>isAccessAllowed</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RolesOrAuthorizationFilter</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获取subject 底层调用的同样是SecurityUtils.getSubject()</span></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> getSubject(request, response);</span><br><span class="line">        String[] rolesArray = (String[]) mappedValue;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rolesArray.length==<span class="number">0</span>||rolesArray==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//对于角色没有要求直接返回true</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Set&lt;String&gt; roles = CollectionUtils.asSet(rolesArray);</span><br><span class="line">        <span class="keyword">for</span> (String role : roles) &#123;</span><br><span class="line">            <span class="comment">//满足一个身份就返回true</span></span><br><span class="line">            <span class="keyword">if</span> (subject.hasRole(role))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加自己的过滤器使其生效"><a href="#添加自己的过滤器使其生效" class="headerlink" title="添加自己的过滤器使其生效"></a>添加自己的过滤器使其生效</h3><p><code>ShiroConfig.java</code> 中添加如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfiguration</span> &#123;</span><br><span class="line">    <span class="comment">//创建 ShiroFilterFactoryBean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(<span class="meta">@Qualifier(&quot;securityManager&quot;)</span> DefaultWebSecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//使自定义的过滤器生效 这里添加我们刚刚自定义的过滤器</span></span><br><span class="line">        shiroFilterFactoryBean.setFilters(filters());</span><br><span class="line">       	</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 自定义过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Filter&gt; <span class="title function_">filters</span><span class="params">()</span>&#123;</span><br><span class="line">        HashMap&lt;String, Filter&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//这里的key 就是后面用于指定过滤器的字段</span></span><br><span class="line">        map.put(<span class="string">&quot;role-or&quot;</span>,<span class="keyword">new</span> <span class="title class_">RolesOrAuthorizationFilter</span>());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//省略其他配置</span></span><br><span class="line">    .... </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Shiro基础五张表"><a href="#Shiro基础五张表" class="headerlink" title="Shiro基础五张表"></a>Shiro基础五张表</h2><p>Shiro最为重要的5张表分别为t_user（用户表）、t_role（角色表）、t_permissions （权限表）、t_user_role（用户角色对应表）、t_role_permissions（角色权限对应表）。</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/2021062816011333.png" alt="在这里插入图片描述"></p>
<h2 id="快速开始（集成SpringBoot-Mybatis-plus）"><a href="#快速开始（集成SpringBoot-Mybatis-plus）" class="headerlink" title="快速开始（集成SpringBoot+Mybatis-plus）"></a>快速开始（集成SpringBoot+Mybatis-plus）</h2><p>整合思路</p>
<p><strong>这里我使用的是<code>Shiro-Spring来整合</code>后面我会使用Shiro官方推出的与SpringBoot整合的jar包进行整合</strong>.</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/20210529132728453.png" alt="在这里插入图片描述"></p>
<h3 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h3><p>Shiro最为重要的5张表分别为t_user（用户表）、t_role（角色表）、t_permissions （权限表）、t_user_role（用户角色对应表）、t_role_permissions（角色权限对应表）。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> Navicat Premium Data Transfer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Source Server         : 阿丁</span></span><br><span class="line"><span class="comment"> Source Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Source Server Version : 50736</span></span><br><span class="line"><span class="comment"> Source Host           : 124.222.35.20:3319</span></span><br><span class="line"><span class="comment"> Source Schema         : shiro</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Target Server Type    : MySQL</span></span><br><span class="line"><span class="comment"> Target Server Version : 50736</span></span><br><span class="line"><span class="comment"> File Encoding         : 65001</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> Date: 24/06/2022 15:51:46</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for permission</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `permission`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `permission`  (</span><br><span class="line">  `p_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;权限编号&#x27;</span>,</span><br><span class="line">  `p_name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`p_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">6</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `role`  (</span><br><span class="line">  `r_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;角色编号&#x27;</span>,</span><br><span class="line">  `r_name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色名称&#x27;</span>,</span><br><span class="line">  `r_state` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色说明&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`r_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">4</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for role_permission</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `role_permission`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `role_permission`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色id&#x27;</span>,</span><br><span class="line">  `pid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;权限id&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">5</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `<span class="keyword">user</span>`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;用户编号&#x27;</span>,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户名称&#x27;</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">200</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户密码&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">4</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `user_role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_role`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;主键&#x27;</span>,</span><br><span class="line">  `uid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户id&#x27;</span>,</span><br><span class="line">  `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;角色id&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h3><p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220624154218271.png" alt="image-20220624154218271"></p>
<h3 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h3><p><code>pom.xml</code>添加相关依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.dyw<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Shiro-SpringBoot-Demo01<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--thymeleaf模板--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-spring5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.0.M1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-java8time<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>application.yml</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://yourip:3306/shiro?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">username</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:org/dyw/shiro/mapper/xml/*.xml</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.dyw.shiro.entity</span></span><br></pre></td></tr></table></figure>



<p><code>因为Shiro-Spring</code>对于SpringBoot没有特殊的适配所以application.yml中无需对shiro进行文本配置。但是我们可以再Spring.xml中配置或是使用配置类的方式进行配置</p>
<h3 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h3><p>这里我们只做演示，所以权限的指定直接在数据库中添加，这里只建用户表（因为无论如何它的信息是要从数据库中获取并且用来验证的）。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName(value = &quot;user&quot;, autoResultMap = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service类"><a href="#Service类" class="headerlink" title="Service类"></a>Service类</h3><p><code>UserService.java</code> 作用就是从数据库中查询用户相关的验证&#x2F;鉴权信息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户名查找用户密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> password</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">queryUserPasswordByUsername</span><span class="params">(String username)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; <span class="title function_">queryUserPermissionByUsername</span><span class="params">(String username)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; <span class="title function_">queryUserRoleByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>UserServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">queryUserPasswordByUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(User::getUsername,username).last(<span class="string">&quot;limit 1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectOne(queryWrapper).getPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">queryUserPermissionByUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectUserPermissionById(username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">queryUserRoleByUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectRoleById(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>UserMapper.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;SELECT permission.p_name FROM ((`user` inner JOIN user_role on `user`.id = user_role.uid) INNER JOIN role_permission on user_role.rid = role_permission.rid) INNER JOIN permission on role_permission.pid = permission.p_id where user.username = #&#123;username&#125;&quot;)</span></span><br><span class="line">    List&lt;String&gt; <span class="title function_">selectUserPermissionById</span><span class="params">(String username)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select role.r_name  from (user inner join user_role on user.id = user_role.uid) inner join role on user_role.rid = role.r_id where user.username = #&#123;username&#125;&quot;)</span></span><br><span class="line">    List&lt;String&gt; <span class="title function_">selectRoleById</span><span class="params">(String username)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>LoginService.java </code> 用于登录</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoginService</span> &#123;</span><br><span class="line"></span><br><span class="line">    Boolean <span class="title function_">login</span><span class="params">(LoginDTO loginDTO)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>LoginServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LoginService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">login</span><span class="params">(LoginDTO loginDTO)</span> &#123;</span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> loginDTO.getUsername();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> loginDTO.getPassword();</span><br><span class="line">        <span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(username, password);</span><br><span class="line">        subject.login(token);</span><br><span class="line">        <span class="keyword">if</span> (subject.isAuthenticated())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="自定义Realm-1"><a href="#自定义Realm-1" class="headerlink" title="自定义Realm"></a>自定义Realm</h3><p>作用就是获取安全数据。</p>
<p>自定义<code>Realm</code>需要继承<code>AuthorizingRealm</code> 并且重写它的两个方法<code>AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals)</code>和<code>AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException</code></p>
<p>其中的<code>doGetAuthenticationInfo</code>方法shi就是<code>Authenticator</code>交给Realm做验证操作的方法，通过方法名字我们也可得知，我们自定义的重写它主要是将数据库中关于该用户的信息查出做一些简单验证，然后将密码用户名和Realm名封装交给后续的处理做验证。</p>
<p><code>doGetAuthorizationInfo</code>方法主要是用来获取用户的权限信息的，通过方法名同样可知，我们自定义的重写它主要是将数据库中关于该用户的权限信息和角色信息查出然后进行打包再返回交给后续程序处理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthorizingRealm</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">principal</span> <span class="operator">=</span> (String) principals.getPrimaryPrincipal();</span><br><span class="line"></span><br><span class="line">        <span class="type">SimpleAuthorizationInfo</span> <span class="variable">authorizationInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthorizationInfo</span>();</span><br><span class="line">        <span class="comment">//通过我们写的方法将数据库关于该用户的信息全部查出</span></span><br><span class="line">        List&lt;String&gt; roles = userService.queryUserRoleByUsername(principal);</span><br><span class="line">        List&lt;String&gt; permissions = userService.queryUserPermissionByUsername(principal);</span><br><span class="line"></span><br><span class="line">        authorizationInfo.addRoles(roles);</span><br><span class="line">        authorizationInfo.addStringPermissions(permissions);</span><br><span class="line">        <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">principal</span> <span class="operator">=</span> (String) token.getPrincipal();</span><br><span class="line">        <span class="comment">//通过我们配置的数据源查询用户密码</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userService.queryUserPasswordByUsername(principal);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(password))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownAccountException</span>(<span class="string">&quot;账户不存在&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(principal,password,getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ShiroConfig"><a href="#ShiroConfig" class="headerlink" title="ShiroConfig"></a>ShiroConfig</h3><p><strong>这部分非常重要</strong></p>
<ol>
<li><p>将我们刚刚自定义的Realm手动配置加入Spring容器管理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserRealm <span class="title function_">userRealm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UserRealm</span> <span class="variable">userRealm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserRealm</span>();</span><br><span class="line">        <span class="comment">//这里指定了加密算法为MD5</span></span><br><span class="line">        userRealm.setCredentialsMatcher(<span class="keyword">new</span> <span class="title class_">HashedCredentialsMatcher</span>(<span class="string">&quot;MD5&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> userRealm;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们创建UserRealm对象的时候指定了密码匹配器，到时后框架会将前端传入的密码进行指定算法的加密然后与数据库中查出的密码进行对比。</p>
</li>
<li><p>创建<code>DefaultWebSecurityManager</code>对象将我们刚刚创建UserRealm注入并且将其添加到securityManager中，然后将<code>DefaultWebSecurityManager</code>以<code>securityManager</code>的实例名称加入IOC容器中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;securityManager&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;userRealm&quot;)</span> UserRealm userRealm)</span> &#123;</span><br><span class="line">    <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">            <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">    <span class="comment">//关联Realm</span></span><br><span class="line">    securityManager.setRealm(userRealm);</span><br><span class="line">    <span class="keyword">return</span> securityManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DefaultWebSecurityManager </code>有着许多默认的配置能够满足我们的一般情况下的需求，但是当需要更为灵活的配置时，它也是支持自定义修改的，我们只需要实现它组件的接口或是继承类重写它的方法，再将自定义的组件加入<code>DefaultWebSecurityManager中即可</code>。</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220624162519708.png" alt="image-20220624162519708"></p>
<p>这里我们就重写了Realm实现了一个自定义的Realm，并且将其加入了其中。</p>
<p>到这里我们对于SecurityManager就已经结束了，我们的Security会自动地注入到SecurityUtils中。</p>
</li>
<li><p>ShiroFilterFactoryBean 创建Shiro的过滤器工厂，在这里面我们可以指定一些restAPI与权限的对应关系，以及其他的配置；</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/image-20220624163304667.png" alt="image-20220624163304667"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(<span class="meta">@Qualifier(&quot;securityManager&quot;)</span> DefaultWebSecurityManager securityManager)</span> &#123;</span><br><span class="line">    <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">    <span class="comment">//设置安全管理器</span></span><br><span class="line">    shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">            添加Shiro内置过滤器，常用的有如下过滤器：</span></span><br><span class="line"><span class="comment">            anon： 无需认证就可以访问</span></span><br><span class="line"><span class="comment">            authc： 必须认证才可以访问</span></span><br><span class="line"><span class="comment">            user： 如果使用了记住我功能就可以直接访问</span></span><br><span class="line"><span class="comment">            perms: 拥有某个资源权限才可以访问</span></span><br><span class="line"><span class="comment">            role： 拥有某个角色权限才可以访问</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">    Map&lt;String, String&gt; filterMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    filterMap.put(<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">    filterMap.put(<span class="string">&quot;/user/add&quot;</span>, <span class="string">&quot;perms[insert]&quot;</span>);</span><br><span class="line">    filterMap.put(<span class="string">&quot;/user/update&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    shiroFilterFactoryBean.setFilterChainDefinitionMap(filterMap);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改到要跳转的login页面；</span></span><br><span class="line">    shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/toLogin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>拦截器对应的不同功能。</p>
<table>
<thead>
<tr>
<th>Filter Name</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td><strong>anno</strong></td>
<td><strong>不需要授权、登录就可以访问。eg:&#x2F;index</strong></td>
</tr>
<tr>
<td><strong>authc</strong></td>
<td><strong>需要登录授权才能访问。eg：&#x2F;用户中心</strong></td>
</tr>
<tr>
<td><strong>authcBasic</strong></td>
<td><strong>Basic HTTP身份验证拦截器</strong></td>
</tr>
<tr>
<td><strong>logout</strong></td>
<td><strong>退出拦截器。退出成功后，会 redirect到设置的&#x2F;URI</strong></td>
</tr>
<tr>
<td><strong>noSessionCreation</strong></td>
<td><strong>不创建会话连接器</strong></td>
</tr>
<tr>
<td><strong>perms</strong></td>
<td><strong>授权拦截器:perm[‘user:create’]</strong></td>
</tr>
<tr>
<td><strong>port</strong></td>
<td><strong>端口拦截器.eg:port[80]</strong></td>
</tr>
<tr>
<td><strong>rest</strong></td>
<td><strong>rest风格拦截器</strong></td>
</tr>
<tr>
<td><strong>roles</strong></td>
<td><strong>角色拦截器。eg：role[administrator]</strong></td>
</tr>
<tr>
<td><strong>ssl</strong></td>
<td><strong>ssl拦截器。通过https协议才能通过</strong></td>
</tr>
<tr>
<td><strong>user</strong></td>
<td><strong>用户拦截器。eg：登录后（authc），第二次没登陆但是有记住我(remmbner)都可以访问。</strong></td>
</tr>
</tbody></table>
<p>完整的配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfiguration</span> &#123;</span><br><span class="line">    <span class="comment">//创建 ShiroFilterFactoryBean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(<span class="meta">@Qualifier(&quot;securityManager&quot;)</span> DefaultWebSecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        <span class="comment">//设置安全管理器</span></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">                添加Shiro内置过滤器，常用的有如下过滤器：</span></span><br><span class="line"><span class="comment">                anon： 无需认证就可以访问</span></span><br><span class="line"><span class="comment">                authc： 必须认证才可以访问</span></span><br><span class="line"><span class="comment">                user： 如果使用了记住我功能就可以直接访问</span></span><br><span class="line"><span class="comment">                perms: 拥有某个资源权限才可以访问</span></span><br><span class="line"><span class="comment">                role： 拥有某个角色权限才可以访问</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">        Map&lt;String, String&gt; filterMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        filterMap.put(<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/user/add&quot;</span>, <span class="string">&quot;perms[insert]&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/user/update&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//修改到要跳转的login页面；</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">&quot;/toLogin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建 DefaultWebSecurityManager( 步骤二</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;securityManager&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;userRealm&quot;)</span> UserRealm userRealm)</span> &#123;</span><br><span class="line">        <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">        <span class="comment">//关联Realm</span></span><br><span class="line">        securityManager.setRealm(userRealm);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建 realm 对象( 步骤一</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserRealm <span class="title function_">userRealm</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">UserRealm</span> <span class="variable">userRealm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserRealm</span>();</span><br><span class="line">        userRealm.setCredentialsMatcher(<span class="keyword">new</span> <span class="title class_">HashedCredentialsMatcher</span>(<span class="string">&quot;MD5&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> userRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>到这里就整合完毕了Controller可以自己根据自己想法定义，restfulAPI的过滤操作可以添加到该类中。</p>
<h3 id="启用Shiro注解进行鉴权"><a href="#启用Shiro注解进行鉴权" class="headerlink" title="启用Shiro注解进行鉴权"></a>启用Shiro注解进行鉴权</h3><p><strong>如果导入的是<code>shiro-spring-boot-web-starter</code>则无需进行如下配置</strong></p>
<p>针对**<code>shiro-spring</code>**要使用Shiro注解进行鉴权需要在ShiroConfig中加上添加如下的配置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 保证实现了Shiro内部lifecycle函数的bean执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean(name = &quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleBeanPostProcessor <span class="title function_">getLifecycleBeanPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LifecycleBeanPostProcessor</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> AOP式方法级权限检查</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@DependsOn(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title function_">getDefaultAdvisorAutoProxyCreator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">DefaultAdvisorAutoProxyCreator</span> <span class="variable">defaultAdvisorAutoProxyCreator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAdvisorAutoProxyCreator</span>();</span><br><span class="line">    defaultAdvisorAutoProxyCreator.setProxyTargetClass(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> defaultAdvisorAutoProxyCreator;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 配合DefaultAdvisorAutoProxyCreator事项注解权限校验</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title function_">getAuthorizationAttributeSourceAdvisor</span><span class="params">(<span class="meta">@Qualifier(&quot;securityManager&quot;)</span> DefaultWebSecurityManager securityManager)</span> &#123;</span><br><span class="line">    <span class="type">AuthorizationAttributeSourceAdvisor</span> <span class="variable">aasa</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuthorizationAttributeSourceAdvisor</span>();</span><br><span class="line">    aasa.setSecurityManager(securityManager);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthorizationAttributeSourceAdvisor</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加上之后可以使用注解了</p>
<p>以下为常用注解</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@RequiresAuthentication</td>
<td>表明当前用户需是经过认证的用户</td>
</tr>
<tr>
<td>@ RequiresGuest</td>
<td>表明该用户需为”guest”用户</td>
</tr>
<tr>
<td>@RequiresPermissions</td>
<td>当前用户需拥有指定权限</td>
</tr>
<tr>
<td>@RequiresRoles</td>
<td>当前用户需拥有指定角色</td>
</tr>
<tr>
<td>@ RequiresUser</td>
<td>当前用户需为已认证用户或已记住用户</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequiresRoles(&quot;admin&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/say&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;==================&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Shiro整合Spring常用注解"><a href="#Shiro整合Spring常用注解" class="headerlink" title="Shiro整合Spring常用注解"></a>Shiro整合Spring常用注解</h2><p>以下为常用注解</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>@RequiresAuthentication</strong></td>
<td><strong>表明当前用户需是经过认证的用户</strong></td>
</tr>
<tr>
<td><strong>@ RequiresGuest</strong></td>
<td><strong>表明该用户需为”guest”用户</strong></td>
</tr>
<tr>
<td><strong>@RequiresPermissions</strong></td>
<td><strong>当前用户需拥有指定权限</strong></td>
</tr>
<tr>
<td><strong>@RequiresRoles</strong></td>
<td><strong>当前用户需拥有指定角色</strong></td>
</tr>
<tr>
<td><strong>@ RequiresUser</strong></td>
<td><strong>当前用户需为已认证用户或已记住用户</strong></td>
</tr>
</tbody></table>
<h2 id="Realm采用Redis作为缓存"><a href="#Realm采用Redis作为缓存" class="headerlink" title="Realm采用Redis作为缓存"></a>Realm采用Redis作为缓存</h2><h3 id="Spring容器工具类"><a href="#Spring容器工具类" class="headerlink" title="Spring容器工具类"></a>Spring容器工具类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationContextUtils</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span>&#123;</span><br><span class="line">    <span class="comment">//放置在获取bean的时候提示空指针，将其定义为静态变量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//类初始化完成之后调用setApplicationContext()方法进行操作</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        ApplicationContextUtils.context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title function_">geteContext</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getBean</span><span class="params">(String beanName)</span>&#123;</span><br><span class="line">        <span class="comment">//在这一步的时候一定要注意，此时可调用这个方法的时候</span></span><br><span class="line">        <span class="comment">//context可能为空，会提示空指针异常，需要将其定义成静态的，这样类加载的时候</span></span><br><span class="line">        <span class="comment">//context就已经存在了</span></span><br><span class="line">        <span class="keyword">return</span> context.getBean(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过这个工具类我们可以获取到容器中的Bean 下面我们会用到</strong></p>
<p>在认证和授权的时候，程序需要频繁的访问数据库，这样对于数据库的压力可想而知，那我们怎么处理呢？</p>
<p>我们可以使用Redis作为缓存来减轻数据库的压力。</p>
<p>Redis的配置不多做介绍</p>
<ol>
<li>导入<code>spring-boot-starter-data-redis</code></li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<ol start="2">
<li><code>RedisConfig</code>Redis配置类配置</li>
</ol>
<p>​    这个类里我们实现了设置缓存、获取缓存、移除缓存、情况缓存等方法。<br>其中我们开启缓存后，用户登录成功就会将缓存放入到redis中，使用退出功能，就会清楚当前登录的缓存信息，授权信息也是一样，只要使用退出功能就会清空当前的缓存信息。但是这里并没有设计过期时间的处理。所以真实场景下，我们还需要考虑过期时间的设置。这里显然我们用到了RedisTemplate模板，这个模板我们一般也是自己定义，不过也可以直接使用SpringBoot默认提供的。这里我们采用自己定义RedisTemplate的方式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">	<span class="meta">@Bean(&quot;redisTemplate&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> StringRedisTemplate <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span>&#123;</span><br><span class="line">        <span class="type">StringRedisTemplate</span> <span class="variable">redisTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisTemplate</span>(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">stringRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        <span class="type">JdkSerializationRedisSerializer</span> <span class="variable">jdkSerializationRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdkSerializationRedisSerializer</span>();</span><br><span class="line">        <span class="type">GenericJackson2JsonRedisSerializer</span> <span class="variable">genericJackson2JsonRedisSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>();</span><br><span class="line"></span><br><span class="line">        redisTemplate.setKeySerializer(stringRedisSerializer);              <span class="comment">//键值序列化方式</span></span><br><span class="line">        redisTemplate.setValueSerializer(jdkSerializationRedisSerializer);</span><br><span class="line">        redisTemplate.setHashKeySerializer(stringRedisSerializer);          <span class="comment">//绑定hash的序列化方式</span></span><br><span class="line">        redisTemplate.setHashValueSerializer(jdkSerializationRedisSerializer);</span><br><span class="line"><span class="comment">//		redisTemplate.setValueSerializer(new GenericJackson2JsonRedisSerializer());</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//redisson配置类</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redissonClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//指定编码，默认编码为org.redisson.codec.JsonJacksonCodec</span></span><br><span class="line">        <span class="comment">//config.setCodec(new org.redisson.client.codec.StringCodec());</span></span><br><span class="line">        config.useSingleServer()</span><br><span class="line">                .setAddress(<span class="string">&quot;redis://124.222.35.20:6666&quot;</span>)</span><br><span class="line">                .setPassword(<span class="string">&quot;dyw20020304&quot;</span>)</span><br><span class="line">                .setConnectionPoolSize(<span class="number">50</span>)</span><br><span class="line">                .setIdleConnectionTimeout(<span class="number">10000</span>)</span><br><span class="line">                .setConnectTimeout(<span class="number">3000</span>)</span><br><span class="line">                .setTimeout(<span class="number">3000</span>)</span><br><span class="line">                .setDatabase(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>提供自定义缓存管理器 <code>RedisCacheManager</code></li>
</ol>
<p>​    只要加入了缓存管理器，配置了缓存管理类，系统就会默认在查询完认证和授权后将信息放入到缓存中且下次需要认证和授权时，都是优先去查询缓存中的内容，查询不到，才会去查询数据库，这里也验证了这一点，与之前的画的加入缓存后的授权信息的获取图是一样的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisCacheManager</span> <span class="keyword">implements</span> <span class="title class_">CacheManager</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;K, V&gt; Cache&lt;K, V&gt; <span class="title function_">getCache</span><span class="params">(String s)</span> <span class="keyword">throws</span> CacheException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;进入到了自定义缓存管理器,传入参数cacheName：&quot;</span>+ s);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedisCache</span>&lt;K,V&gt;(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="4">
<li>设计自己的缓存管理类 实现shiro的Cache&lt;K,V&gt;接口</li>
</ol>
<p>​    所有的缓存管理类的实例都应该是Cache的实现类。所以我们自己定义redis的缓存管理类应该也必须去实现这个Cache类。实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisCache</span>&lt;k,V&gt; <span class="keyword">implements</span> <span class="title class_">Cache</span>&lt;k,V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String cacheName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisCache</span> <span class="params">(String cacheName)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.cacheName = cacheName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取redis操作对象</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate <span class="title function_">getRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">RedisTemplate</span> <span class="variable">redisTemplate</span> <span class="operator">=</span> (RedisTemplate) ApplicationContextUtils.getBean(<span class="string">&quot;redisTemplate&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(k k)</span> <span class="keyword">throws</span> CacheException &#123;</span><br><span class="line">        System.out.println(cacheName+<span class="string">&quot;:获取缓存方法，传入参数：&quot;</span> + k+<span class="string">&quot;,此时的redisTemplate:&quot;</span>+getRedisTemplate());</span><br><span class="line">        <span class="keyword">return</span> (V) getRedisTemplate().opsForHash().get(cacheName,k.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(k k, V v)</span> <span class="keyword">throws</span> CacheException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;加入缓存方法，传入参数 K:&quot;</span> + k+<span class="string">&quot;,V:&quot;</span>+v);</span><br><span class="line">        <span class="comment">//放入redis中的值，一定要是序列化的对象</span></span><br><span class="line">        getRedisTemplate().opsForHash().put(cacheName.toString(),k.toString(),v);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(k k)</span> <span class="keyword">throws</span> CacheException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了remove方法,传入参数：&quot;</span>+k.toString());</span><br><span class="line">        getRedisTemplate().opsForHash().delete(cacheName,k.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> <span class="keyword">throws</span> CacheException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了clear方法&quot;</span>);</span><br><span class="line">        getRedisTemplate().opsForHash().delete(cacheName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getRedisTemplate().opsForHash().size(cacheName).intValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;k&gt; <span class="title function_">keys</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getRedisTemplate().opsForHash().keys(cacheName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;V&gt; <span class="title function_">values</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getRedisTemplate().opsForHash().values(cacheName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5. </p>
<p>​    开启Realm的缓存</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> UserRealm <span class="title function_">userRealm</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="type">UserRealm</span> <span class="variable">userRealm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserRealm</span>();</span><br><span class="line">       userRealm.setCredentialsMatcher(<span class="keyword">new</span> <span class="title class_">HashedCredentialsMatcher</span>(<span class="string">&quot;MD5&quot;</span>));</span><br><span class="line">       <span class="comment">//开启缓存</span></span><br><span class="line">       userRealm.setAuthenticationCachingEnabled(<span class="literal">true</span>);</span><br><span class="line">       userRealm.setAuthorizationCacheName(<span class="string">&quot;authenticationCache&quot;</span>); <span class="comment">//设置缓存名称--认证</span></span><br><span class="line">       userRealm.setAuthenticationCacheName(<span class="string">&quot;authorizationCache&quot;</span>); <span class="comment">//设置缓存名称--授权</span></span><br><span class="line">       userRealm.setCacheManager(<span class="keyword">new</span> <span class="title class_">RedisCacheManager</span>());<span class="comment">//设置为我们刚刚自定义的RedisCacheManager</span></span><br><span class="line">       <span class="keyword">return</span> userRealm;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>经过验证发现,在用户登录过后访问需要权限的资源后,确实不再走数据库,而是从Redis缓存中查找信息。</p>
<h2 id="Shiro共享Session"><a href="#Shiro共享Session" class="headerlink" title="Shiro共享Session"></a>Shiro共享Session</h2><h3 id="会话的问题"><a href="#会话的问题" class="headerlink" title="会话的问题"></a>会话的问题</h3><p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/1581846589128.png" alt="1581846589128"></p>
<h3 id="分布式会话实现思路"><a href="#分布式会话实现思路" class="headerlink" title="分布式会话实现思路"></a>分布式会话实现思路</h3><p>所有服务器的session信息都存储到了同一个Redis集群中，即所有的服务都将 Session 的信息存储到 Redis 集群中，无论是对 Session 的注销、更新都会同步到集群中，达到了 Session 共享的目的。</p>
<p><img src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/1581846769926.png" alt="1581846769926"></p>
<p>​        Cookie 保存在客户端浏览器中，而 Session 保存在服务器上。客户端浏览器访问服务器的时候，服务器把客户端信息以某种形式记录在服务器上，这就是 Session。客户端浏览器再次访问时只需要从该 Session 中查找该客户的状态就可以了。</p>
<p>​        在实际工作中我们建议使用外部的缓存设备(包括Redis)来共享 Session，避免单个服务器节点挂掉而影响服务，共享数据都会放到外部缓存容器中</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol>
<li><p>编写RedisSessionDao继承AbstractSessionDAO，重写了会话的创建、读取、修改等操作，全部缓存与redis中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSessionDAO</span> <span class="keyword">extends</span> <span class="title class_">AbstractSessionDAO</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Serializable <span class="title function_">doCreate</span><span class="params">(Session session)</span> &#123;</span><br><span class="line">        <span class="type">Serializable</span> <span class="variable">sessionId</span> <span class="operator">=</span> generateSessionId(session);</span><br><span class="line">        assignSessionId(session,sessionId);</span><br><span class="line"></span><br><span class="line">        redisTemplate.opsForValue().set(session.getId().toString(),session,<span class="number">60</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> sessionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Session <span class="title function_">doReadSession</span><span class="params">(Serializable sessionId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">return</span> <span class="variable">sessionId</span> <span class="operator">=</span>= <span class="literal">null</span> ? <span class="literal">null</span> : (Session) redisTemplate.opsForValue().get(sessionId.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Session session)</span> <span class="keyword">throws</span> UnknownSessionException &#123;</span><br><span class="line">        <span class="keyword">if</span> (session!=<span class="literal">null</span>&amp;&amp;session.getId()!=<span class="literal">null</span>)&#123;</span><br><span class="line">            session.setTimeout(<span class="number">3600</span> * <span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        redisTemplate.opsForValue().set(session.getId().toString(),session,<span class="number">60</span>,TimeUnit.MINUTES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">(Session session)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (session!=<span class="literal">null</span>&amp;session.getId()!=<span class="literal">null</span>)&#123;</span><br><span class="line">            redisTemplate.opsForValue().getOperations().delete(session.getId().toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;Session&gt; <span class="title function_">getActiveSessions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以根据需求做更多灵活性的改动。</p>
</li>
<li><p>ShiroConfig将RedisSessionDao注入SessionManager中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> DefaultWebSessionManager <span class="title function_">defaultWebSessionManager</span><span class="params">(RedisSessionDAO redisSessionDAO)</span> &#123;</span><br><span class="line">       <span class="type">DefaultWebSessionManager</span> <span class="variable">defaultWebSessionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSessionManager</span>();</span><br><span class="line">       defaultWebSessionManager.setGlobalSessionTimeout(<span class="number">3600</span> * <span class="number">1000</span>);</span><br><span class="line">       defaultWebSessionManager.setDeleteInvalidSessions(<span class="literal">true</span>);</span><br><span class="line">       defaultWebSessionManager.setSessionDAO(redisSessionDAO);</span><br><span class="line">       defaultWebSessionManager.setSessionValidationSchedulerEnabled(<span class="literal">true</span>);</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 修改Cookie中的SessionId的key，默认为JSESSIONID，自定义名称</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       defaultWebSessionManager.setSessionIdCookie(<span class="keyword">new</span> <span class="title class_">SimpleCookie</span>(<span class="string">&quot;JSESSIONID&quot;</span>));</span><br><span class="line">       <span class="keyword">return</span> defaultWebSessionManager;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将SessionManager注入SecurityManager中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;securityManager&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;userRealm&quot;)</span> UserRealm userRealm, RedisSessionDAO redisSessionDao)</span> &#123;</span><br><span class="line">    <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">            <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">    <span class="comment">//关联Realm</span></span><br><span class="line">    securityManager.setRealm(userRealm);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 取消Cookie中的RememberMe参数</span></span><br><span class="line">    securityManager.setRememberMeManager(<span class="literal">null</span>);</span><br><span class="line">    securityManager.setSessionManager(defaultWebSessionManager(redisSessionDao));</span><br><span class="line">    <span class="keyword">return</span> securityManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>做完上述操作在进行访问我们可以看到我们的session已经存入了redis中</p>
</li>
</ol>
<h2 id="限制密码重试次数"><a href="#限制密码重试次数" class="headerlink" title="限制密码重试次数"></a>限制密码重试次数</h2><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>保证原子性：</p>
<p>​        单系统：AtomicLong计数</p>
<p>​        集群系统：使用Redis提供的RAtomicLong计数</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">1、获取系统中是否已有登录次数缓存,缓存对象结构预期为：&quot;用户名--登录次数&quot;。</span><br><span class="line"></span><br><span class="line">2、如果之前没有登录缓存，则创建一个登录次数缓存。</span><br><span class="line"></span><br><span class="line">3、如果缓存次数已经超过限制，则驳回本次登录请求。</span><br><span class="line"></span><br><span class="line">4、将缓存记录的登录次数加1,设置指定时间内有效</span><br><span class="line"></span><br><span class="line">5、验证用户本次输入的帐号密码，如果登录登录成功，则清除掉登录次数的缓存</span><br></pre></td></tr></table></figure>

<p>计数缓存的部分主要是在登录验证密码的时候。所以我们需要自定义一个密码比较器。</p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><ol>
<li>自定义密码比较器RetryLimitCredentialsMatcher继承HashedCredentialsMatcher重写doCredentialsMatch方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RetryLimitCredentialsMatcher</span> <span class="keyword">extends</span> <span class="title class_">HashedCredentialsMatcher</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Long</span> <span class="variable">RETRY_LIMIT_NUM</span> <span class="operator">=</span> <span class="number">4L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate <span class="title function_">getRedisTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">RedisTemplate</span> <span class="variable">redisTemplate</span> <span class="operator">=</span> (RedisTemplate) ApplicationContextUtils.getBean(<span class="string">&quot;redisTemplate&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RetryLimitCredentialsMatcher</span><span class="params">(String hashAlgorithmName)</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>(hashAlgorithmName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">doCredentialsMatch</span><span class="params">(AuthenticationToken token, AuthenticationInfo info)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;进入自定义密码比较器&quot;</span>);</span><br><span class="line">        <span class="comment">//获得用户名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loginName</span> <span class="operator">=</span> (String) token.getPrincipal();</span><br><span class="line">        <span class="comment">//获得缓存</span></span><br><span class="line">        log.info(loginName);</span><br><span class="line">        <span class="type">RedisAtomicLong</span> <span class="variable">atomicLong</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisAtomicLong</span>(loginName, getRedisTemplate().getConnectionFactory());</span><br><span class="line">        <span class="type">long</span> <span class="variable">retryFlag</span> <span class="operator">=</span> atomicLong.get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断次数</span></span><br><span class="line">        <span class="keyword">if</span> (retryFlag&gt;RETRY_LIMIT_NUM)&#123;</span><br><span class="line">            <span class="comment">//超过次数设计10分钟后重试</span></span><br><span class="line">            atomicLong.expire(<span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">            log.error(<span class="string">&quot;密码错误5次，请10分钟以后再试&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExcessiveAttemptsException</span>(<span class="string">&quot;密码错误5次，请10分钟以后再试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//没有超过</span></span><br><span class="line">        <span class="comment">//累加次数</span></span><br><span class="line">        atomicLong.incrementAndGet();</span><br><span class="line">        atomicLong.expire(<span class="number">10</span>,TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">//密码校验</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="built_in">super</span>.doCredentialsMatch(token, info);</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,atomicLong.get());</span><br><span class="line">        <span class="comment">//如果登录成功 清除缓存</span></span><br><span class="line">        <span class="keyword">if</span> (flag)&#123;</span><br><span class="line">            atomicLong.expire(<span class="number">0</span>,TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编写完成后记得将我们一开始设置的Shiro自带的密码比较器更换为我们自定义的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">userRealm.setCredentialsMatcher(<span class="keyword">new</span> <span class="title class_">RetryLimitCredentialsMatcher</span>(<span class="string">&quot;MD5&quot;</span>));</span><br></pre></td></tr></table></figure>



<h2 id="在线并发登录人数控制"><a href="#在线并发登录人数控制" class="headerlink" title="在线并发登录人数控制"></a>在线并发登录人数控制</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>在实际开发中，我们可能会遇到这样的需求，一个账号只允许同时一个在线，当账号在其他地方登陆的时候，会踢出前面登陆的账号，那我们怎么实现</p>
<ul>
<li>自定义过滤器:继承AccessControlFilter</li>
<li>使用redis队列控制账号在线数目</li>
</ul>
<p>实现步骤：</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">1、只针对登录用户处理，首先判断是否登录</span><br><span class="line">2、使用RedissionClien创建队列</span><br><span class="line">3、判断当前sessionId是否存在于此用户的队列=key:登录名 value：多个sessionId</span><br><span class="line">4、不存在则放入队列尾端==&gt;存入sessionId</span><br><span class="line">5、判断当前队列大小是否超过限定此账号的可在线人数</span><br><span class="line">6、超过：</span><br><span class="line">	*从队列头部拿到用户sessionId</span><br><span class="line">	*从sessionManger根据sessionId拿到session</span><br><span class="line">	*从sessionDao中移除session会话</span><br><span class="line">7、未超过：放过操作</span><br></pre></td></tr></table></figure>

<h3 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h3><p><code>AccessControlFilter：</code>控制对资源的访问的任何过滤器的超类，如果用户未通过身份验证，则可以将用户重定向到登录页面。这个超类提供了方法，借助它可以在用户超出登录最大在线人数后将其的session删除并且重定向到登录页面。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KickedOutAuthorizationFilter</span> <span class="keyword">extends</span> <span class="title class_">AccessControlFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DefaultWebSessionManager sessionManager;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisSessionDAO redisSessionDAO;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> getSubject(request, response);</span><br><span class="line">        <span class="keyword">if</span> (!subject.isAuthenticated()) &#123;</span><br><span class="line">            <span class="comment">//如果没有登录，直接进行之后的流程</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//存放session对象进入队列</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> (String) subject.getSession().getId();</span><br><span class="line">        <span class="type">String</span> <span class="variable">LoginName</span> <span class="operator">=</span> (String) subject.getPrincipal();</span><br><span class="line">        RDeque&lt;String&gt; queue = redissonClient.getDeque(<span class="string">&quot;KickedOutAuthorizationFilter:&quot;</span>+LoginName);</span><br><span class="line">        <span class="comment">//判断sessionId是否存在于此用户的队列中</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> queue.contains(sessionId);</span><br><span class="line">        <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">            queue.addLast(sessionId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果此时队列大于1，则开始踢人</span></span><br><span class="line">        <span class="keyword">if</span> (queue.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            sessionId = queue.getFirst();</span><br><span class="line">            queue.removeFirst();</span><br><span class="line">            <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                session = sessionManager.getSession(<span class="keyword">new</span> <span class="title class_">DefaultSessionKey</span>(sessionId));</span><br><span class="line">            &#125;<span class="keyword">catch</span> (UnknownSessionException ex)&#123;</span><br><span class="line">                log.info(<span class="string">&quot;session已经失效&quot;</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (ExpiredSessionException expiredSessionException)&#123;</span><br><span class="line">                log.info(<span class="string">&quot;session已经过期&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (session!=<span class="literal">null</span>)&#123;</span><br><span class="line">                redisSessionDAO.delete(session);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>修改ShiroConfig将我们自定义的过滤器添加进ShiroFilterFactoryBean中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> KickedOutAuthorizationFilter kickedOutAuthorizationFilter;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@Description</span> 自定义过滤器定义</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Filter&gt; <span class="title function_">filters</span><span class="params">()</span> &#123;</span><br><span class="line">    HashMap&lt;String, Filter&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;kickedOut&quot;</span>,kickedOutAuthorizationFilter);</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>拦截所有需要登录的路径</li>
</ol>
</li>
<li><p>测试有效</p>
</li>
</ol>
<h2 id="SpringBoot-Shiro-Jwt整合"><a href="#SpringBoot-Shiro-Jwt整合" class="headerlink" title="SpringBoot+Shiro+Jwt整合"></a>SpringBoot+Shiro+Jwt整合</h2><h3 id="问题追踪"><a href="#问题追踪" class="headerlink" title="问题追踪"></a>问题追踪</h3><p>​    前面我们实现分布式的会话缓存，但是我们发现此功能的实现是基于浏览的cookie机制，也就是说用户禁用cookie后，我们的系统会就会产生会话不同的问题</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>​    我们的前端可能是web、Android、ios等应用，同时我们每一个接口都提供了无状态的应答方式，这里我们提供了基于JWT的token生成方案</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">1、用户登陆之后，获得此时会话的sessionId,使用JWT根据sessionId颁发签名并设置过期时间(与session过期时间相同)返回token</span><br><span class="line"></span><br><span class="line">2、将token保存到客户端本地，并且每次发送请求时都在header上携带JwtToken</span><br><span class="line"></span><br><span class="line">3、ShiroSessionManager继承DefaultWebSessionManager，重写getSessionId方法，从header上检测是否携带JwtToken，如果携带，则进行解码JwtToken，使用JwtToken中的jti作为SessionId。</span><br><span class="line"></span><br><span class="line">4、重写shiro的默认过滤器，使其支持jwtToken有效期校验、及对JSON的返回支持</span><br><span class="line">	JwtAuthcFilter:实现是否需要登录的过滤，拒绝时如果header上携带JwtToken,则返回对应json</span><br><span class="line">	JwtPermsFilter:实现是否有对应资源的过滤，拒绝时如果header上携带JwtToken,则返回对应json</span><br><span class="line">	JwtRolesFilter:实现是否有对应角色的过滤，拒绝时如果header上携带JwtToken,则返回对应json</span><br></pre></td></tr></table></figure>

<h3 id="JWT概述"><a href="#JWT概述" class="headerlink" title="JWT概述"></a>JWT概述</h3><p>JWT（JSON WEB TOKEN）：JSON网络令牌，JWT是一个轻便的安全跨平台传输格式，定义了一个紧凑的自包含的方式在不同实体之间安全传输信息（JSON格式）。它是在Web环境下两个实体之间传输数据的一项标准。实际上传输的就是一个字符串。</p>
<ul>
<li><p>广义上：JWT是一个标准的名称；</p>
</li>
<li><p>狭义上：JWT指的就是用来传递的那个token字符串</p>
</li>
</ul>
<p>JWT由三部分构成：header（头部）、payload（载荷）和signature（签名）。</p>
<ol>
<li><p>Header</p>
<p>存储两个变量</p>
<ol>
<li>秘钥（可以用来比对）</li>
<li>算法（也就是下面将Header和payload加密成Signature）</li>
</ol>
</li>
<li><p>payload</p>
<p>存储很多东西，基础信息有如下几个</p>
<ol>
<li>签发人，也就是这个“令牌”归属于哪个用户。一般是<code>userId</code> </li>
<li>创建时间，也就是这个令牌是什么时候创建的</li>
<li>失效时间，也就是这个令牌什么时候失效(session的失效时间)</li>
<li>唯一标识，一般可以使用算法生成一个唯一标识（jti&#x3D;&#x3D;&gt;sessionId）</li>
</ol>
</li>
<li><p>Signature</p>
<p>这个是上面两个经过Header中的算法加密生成的，用于比对信息，防止篡改Header和payload</p>
</li>
</ol>
<p>然后将这三个部分的信息经过加密生成一个<code>JwtToken</code>的字符串，发送给客户端，客户端保存在本地。当客户端发起请求的时候携带这个到服务端(可以是在<code>cookie</code>，可以是在<code>header</code>)，在服务端进行验证，我们需要解密对于的payload的内容</p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><ol>
<li><p>首先导入Jwt的依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.11.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编写一个Jwt的工具类用于签发令牌,验证令牌等。</p>
<p>这个可以根据实际项目情况进行自定义更改（例如JWT密钥的指定）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt加密密钥 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_SECRET</span> <span class="operator">=</span> <span class="string">&quot;aPbOBbnH4gnZBzIYEY7mxWNu49kYljNPMeva9Fjrwwqzw0bFlO0kPXZTCGaVcw0j&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 签发令牌</span></span><br><span class="line"><span class="comment">     *      jwt字符串包括三个部分</span></span><br><span class="line"><span class="comment">     *        1. header</span></span><br><span class="line"><span class="comment">     *            -当前字符串的类型，一般都是“JWT”</span></span><br><span class="line"><span class="comment">     *            -哪种算法加密，“HS256”或者其他的加密算法</span></span><br><span class="line"><span class="comment">     *            所以一般都是固定的，没有什么变化</span></span><br><span class="line"><span class="comment">     *        2. payload</span></span><br><span class="line"><span class="comment">     *            一般有四个最常见的标准字段（下面有）</span></span><br><span class="line"><span class="comment">     *            iat：签发时间，也就是这个jwt什么时候生成的</span></span><br><span class="line"><span class="comment">     *            jti：JWT的唯一标识</span></span><br><span class="line"><span class="comment">     *            iss：签发人，一般都是username或者userId</span></span><br><span class="line"><span class="comment">     *            exp：过期时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> iss 签发人</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ttlMillis 有效时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id jwt中存储的用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> jws</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">IssuedToken</span><span class="params">(String iss, <span class="type">long</span> ttlMillis,String sessionId, Integer id)</span> &#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (id != <span class="literal">null</span>) &#123;</span><br><span class="line">            claims.put(<span class="string">&quot;userId&quot;</span>,id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">SignatureAlgorithm</span> <span class="variable">signatureAlgorithm</span> <span class="operator">=</span> SignatureAlgorithm.HS256;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">nowMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">secretKey</span> <span class="operator">=</span> generalKey();</span><br><span class="line"></span><br><span class="line">        <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                .setId(sessionId)<span class="comment">//2. 这个是JWT的唯一标识，一般设置成唯一的，这个方法可以生成唯一标识,此时存储的为sessionId,登录成功后回写</span></span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>(nowMillis))<span class="comment">//1. 这个地方就是以毫秒为单位，换算当前系统时间生成的iat</span></span><br><span class="line">                .setSubject(iss)<span class="comment">//3. 签发人，也就是JWT是给谁的（逻辑上一般都是username或者userId）</span></span><br><span class="line">                .signWith(signatureAlgorithm, secretKey);<span class="comment">//这个地方是生成jwt使用的算法和秘钥</span></span><br><span class="line">        <span class="keyword">if</span> (ttlMillis &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">expMillis</span> <span class="operator">=</span> nowMillis + ttlMillis;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expMillis);<span class="comment">//4. 过期时间，这个也是使用毫秒生成的，使用当前时间+前面传入的持续时间生成</span></span><br><span class="line">            builder.setExpiration(exp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 解析令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtToken 令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title function_">decodeToken</span><span class="params">(String jwtToken)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">secretKey</span> <span class="operator">=</span> generalKey();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 得到 DefaultJwtParser</span></span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                <span class="comment">// 设置签名的秘钥</span></span><br><span class="line">                .setSigningKey(secretKey)</span><br><span class="line">                <span class="comment">// 设置需要解析的 jwt</span></span><br><span class="line">                .parseClaimsJws(jwtToken)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 由字符串生成加密key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> SecretKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SecretKey <span class="title function_">generalKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">stringKey</span> <span class="operator">=</span> JWT_SECRET;</span><br><span class="line">        <span class="type">byte</span>[] encodedKey = BaseEncoding.base64().decode(stringKey);</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">key</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(encodedKey, <span class="number">0</span>, encodedKey.length, <span class="string">&quot;HmacSHA256&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>继承<code>DefaultWebSessionManager</code>重写<code>getSessionId</code>方法 </p>
<p><code>getSessionId()</code>方法就是Shiro用于获取SessionId的方法，默认是从cookie中获取，但是我们采用JWT了，就得从Jwt中获取所以我们对该方法进行了修改。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroSessionManager</span> <span class="keyword">extends</span> <span class="title class_">DefaultWebSessionManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUTHORIZATION</span> <span class="operator">=</span> <span class="string">&quot;token&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REFERENCED_SESSION_ID_SOURCE</span> <span class="operator">=</span> <span class="string">&quot;Stateless request&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ShiroSessionManager</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个方法主要是让我们自定义获取sessionId的方法 在将sessionId返回让后续的流程去获取session 然后鉴权</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Serializable <span class="title function_">getSessionId</span><span class="params">(ServletRequest request, ServletResponse response)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> WebUtils.toHttp(request).getHeader(AUTHORIZATION);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(jwtToken))&#123;</span><br><span class="line">            <span class="comment">//如果没有携带id参数则按照父类的方式在cookie进行获取</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.getSessionId(request, response);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//如果请求头中有 authToken 则其值为jwtToken，然后解析出会话id sessionId</span></span><br><span class="line">					                                                  request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_SOURCE,REFERENCED_SESSION_ID_SOURCE);</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">decode</span> <span class="operator">=</span> JwtTokenUtil.decodeToken(jwtToken);</span><br><span class="line">            <span class="comment">//获取我们创建jwt时填入的sessionId</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> (String) decode.get(<span class="string">&quot;jti&quot;</span>);</span><br><span class="line">            log.info(id); request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID,id);</span><br><span class="line">            request.setAttribute(ShiroHttpServletRequest.REFERENCED_SESSION_ID_IS_VALID,Boolean.TRUE);</span><br><span class="line">            <span class="keyword">return</span> id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：我们这里获取到了sessionId后 Shiro框架会将SessionId传入SessionDAO中去获取Session 再通过Session中存储的用户登录权限信息进行鉴权</strong>。</p>
</li>
<li><p>自定义重写三类Shiro过滤器</p>
<p>之所以要重写是为了更好的适配前后端分离的项目，因为Shiro默认过滤器没有通过是会返回一个页面的，但是前后端分离的项目不需要你去返回页面了，所以我们需要重写我们要使用的过滤器使其返回前后端规定好的对象返回。</p>
<p>重写<code>authc</code>过滤器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthcFilter</span> <span class="keyword">extends</span> <span class="title class_">FormAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 是否允许访问</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> &#123;</span><br><span class="line">        <span class="comment">//判断当前请求头中是否带有jwtToken的字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> WebUtils.toHttp(request).getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有：走jwt校验</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(jwtToken))&#123;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtTokenUtil.decodeToken(jwtToken);</span><br><span class="line">            <span class="keyword">if</span> (!claims.isEmpty())&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.isAccessAllowed(request, response, mappedValue);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//没有携带token：走原始校验</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.isAccessAllowed(request, response, mappedValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 访问拒绝时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//判断当前请求头中是否带有jwtToken的字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> WebUtils.toHttp(request).getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有：返回json的应答</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(jwtToken))&#123;</span><br><span class="line">            Result&lt;String&gt; result = ResultUtil.fail(<span class="string">&quot;没有登录&quot;</span>);</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json; charset=utf-8&quot;</span>);</span><br><span class="line">            response.getWriter().write(JSONObject.toJSONString(result));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有：走原始方式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onAccessDenied(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重写<code>perms</code>过滤器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtPermsFilter</span> <span class="keyword">extends</span> <span class="title class_">PermissionsAuthorizationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 访问拒绝时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//判断当前请求头中是否带有jwtToken的字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> WebUtils.toHttp(request).getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有：返回json的应答</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(jwtToken))&#123;</span><br><span class="line">            Result&lt;String&gt; result = ResultUtil.fail(<span class="string">&quot;没有权限&quot;</span>);</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json; charset=utf-8&quot;</span>);</span><br><span class="line">            response.getWriter().write(JSONObject.toJSONString(result));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有：走原始方式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onAccessDenied(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重写<code>roles</code>过滤器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtRolesFilter</span> <span class="keyword">extends</span> <span class="title class_">RolesAuthorizationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 访问拒绝时调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//判断当前请求头中是否带有jwtToken的字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> WebUtils.toHttp(request).getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="comment">//如果有：返回json的应答</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(jwtToken))&#123;</span><br><span class="line">            Result&lt;String&gt; result = ResultUtil.fail(<span class="string">&quot;没有角色&quot;</span>);</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json; charset=utf-8&quot;</span>);</span><br><span class="line">            response.getWriter().write(JSONObject.toJSONString(result));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果没有：走原始方式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onAccessDenied(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将新增配置添加进ShiroConfig配置类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 会话管理器</span></span><br><span class="line"><span class="comment"> * 将刚刚创建好的会话管理器添加进配置类中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean(name=&quot;sessionManager&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ShiroSessionManager <span class="title function_">shiroSessionManager</span><span class="params">(RedisSessionDAO redisSessionDAO)</span>&#123;</span><br><span class="line">    <span class="type">ShiroSessionManager</span> <span class="variable">sessionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroSessionManager</span>();</span><br><span class="line">    sessionManager.setSessionDAO(redisSessionDAO);</span><br><span class="line">    sessionManager.setSessionValidationSchedulerEnabled(<span class="literal">false</span>);</span><br><span class="line">    sessionManager.setSessionIdCookieEnabled(<span class="literal">true</span>);</span><br><span class="line">    sessionManager.setSessionIdCookie(simpleCookie());</span><br><span class="line">    <span class="comment">//设置超时</span></span><br><span class="line">    sessionManager.setGlobalSessionTimeout(<span class="number">3600</span>*<span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">return</span> sessionManager;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 创建cookie对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean(name=&quot;sessionIdCookie&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SimpleCookie <span class="title function_">simpleCookie</span><span class="params">()</span>&#123;</span><br><span class="line">   <span class="type">SimpleCookie</span> <span class="variable">simpleCookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleCookie</span>();</span><br><span class="line">   simpleCookie.setName(<span class="string">&quot;ShiroSession&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> simpleCookie;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 自定义过滤器定义</span></span><br><span class="line"><span class="comment"> * 将我们重写三个过滤器添加进来 为了后面添加进过滤器工厂做准备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Filter&gt; <span class="title function_">filters</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, Filter&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Filter&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;jwt-authc&quot;</span>, <span class="keyword">new</span> <span class="title class_">JwtAuthcFilter</span>());</span><br><span class="line">    map.put(<span class="string">&quot;jwt-perms&quot;</span>, <span class="keyword">new</span> <span class="title class_">JwtPermsFilter</span>());</span><br><span class="line">    map.put(<span class="string">&quot;jwt-roles&quot;</span>, <span class="keyword">new</span> <span class="title class_">JwtRolesFilter</span>());</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将自定义的会话管理器添加进securityManager中</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Bean(name = &quot;securityManager&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;userRealm&quot;)</span> UserRealm userRealm, RedisSessionDAO redisSessionDAO)</span> &#123;</span><br><span class="line">    <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">            <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">    <span class="comment">//关联Realm</span></span><br><span class="line">    securityManager.setRememberMeManager(<span class="literal">null</span>);</span><br><span class="line">    securityManager.setSessionManager(shiroSessionManager(redisSessionDAO)); <span class="comment">//这里添加自定义会话管理器</span></span><br><span class="line">    securityManager.setRealm(userRealm);</span><br><span class="line">    <span class="keyword">return</span> securityManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//将刚刚三个自定义的过滤器添加进过滤器工厂中。</span></span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilterFactoryBean&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(DefaultWebSecurityManager securityManager)</span> &#123;</span><br><span class="line">        <span class="type">ShiroFilterFactoryBean</span> <span class="variable">shiroFilterFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">        <span class="comment">//设置安全管理器</span></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">        shiroFilterFactoryBean.setFilters(filters()); <span class="comment">//将刚刚三个自定义的过滤器添加进过滤器工厂中。</span></span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>如果要使用刚刚三个自定义的过滤器进行过滤器拦截的话 就需要使用那个三个自定义的关键词来配置过滤。</p>
</li>
<li><p><code>LoginService</code>中的<code>Login</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">loginForJwt</span><span class="params">(LoginDTO loginDTO)</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">String</span> <span class="variable">jwtToken</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(loginDTO.getUsername(), loginDTO.getPassword());</span><br><span class="line">            <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">            subject.login(token);</span><br><span class="line">            <span class="type">String</span> <span class="variable">shiroSessionId</span> <span class="operator">=</span> (String) subject.getSession().getId();</span><br><span class="line">            <span class="comment">//登录后颁发的令牌</span></span><br><span class="line">            LambdaQueryWrapper&lt;User&gt; userLambdaQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">            userLambdaQueryWrapper.eq(User::getUsername,loginDTO.getUsername());</span><br><span class="line">            <span class="type">User</span> <span class="variable">shiroUser</span> <span class="operator">=</span> userMapper.selectOne(userLambdaQueryWrapper);</span><br><span class="line">            jwtToken = JwtTokenUtil.IssuedToken(<span class="string">&quot;system&quot;</span>, subject.getSession().getTimeout(),shiroSessionId,shiroUser.getId());</span><br><span class="line">            map.put(<span class="string">&quot;jwtToken&quot;</span>,jwtToken );</span><br><span class="line">            log.info(<span class="string">&quot;jwtToken:&#123;&#125;&quot;</span>,map.toString());</span><br><span class="line">            <span class="comment">//创建缓存</span></span><br><span class="line"><span class="comment">//            this.loadAuthorityToCache();</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResultUtil.fail(<span class="string">&quot;登录失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResultUtil.succeed(map);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>主旨就是使用Shiro的login方法进行登录，登录如果没有抛出异常则说明登录成功，登录成功后将sessionId封装成JWS返回到前端，</p>
<p>后续的前端通过在请求头部添加token的方式将token发送到后端，后端通过自定义的会话管理器（<code>ShiroSessionManager</code>）的<code>getSessionId</code>的方法解码<code>token</code>获得其中的<code>sessionId</code>， 再由后续的<code>SessionDAO</code>通过<code>SessionId</code>获得<code>Session</code>进行登录鉴权。</p>
</li>
</ol>
<hr>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><h3 id="盐序列化"><a href="#盐序列化" class="headerlink" title="盐序列化"></a>盐序列化</h3><p>当我们的密码有加密盐的时候若想使用<code>Redis</code>作为<code>Realm</code>的缓存,需要重写实现<code>ByteSource</code>接口，因为<code>Redis</code>存储信息的时候需要对信息进行序列化后才能进行存储，但是<code>ByteSource</code>的实现类<code>SimpleByteSource</code>并没有实现序列化(即没有实现<code>Serializable</code>接口)，同时由于<code>SimpleByteSource</code>没有无参构造导致无法反序列化。</p>
<p>重写后的<code>MyByteSource</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ： Donald</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> ： 2020/10/18 17:41</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>： 自定义salt的实现 主要巍峨salt的序列化</span></span><br><span class="line"><span class="comment"> * 采用redis缓存shiro的认证信息，并且要对这些信息进行序列化后再存储，但是序列化的时候，SimpleByteSource类没有实现Serializable接口，导致序列化失败</span></span><br><span class="line"><span class="comment"> * SimpleByteSource没有默认构造方法，导致反序列化的时候失败</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyByteSource</span> <span class="keyword">implements</span> <span class="title class_">ByteSource</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*这里将final去掉了,去掉后要在后面用getter和setter赋、取值*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] bytes;</span><br><span class="line">    <span class="keyword">private</span> String cachedHex;</span><br><span class="line">    <span class="keyword">private</span> String cachedBase64;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*添加了一个无参构造方法*/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyByteSource</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyByteSource</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bytes = bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyByteSource</span><span class="params">(<span class="type">char</span>[] chars)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bytes = CodecSupport.toBytes(chars);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyByteSource</span><span class="params">(String string)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bytes = CodecSupport.toBytes(string);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyByteSource</span><span class="params">(ByteSource source)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bytes = source.getBytes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyByteSource</span><span class="params">(File file)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bytes = (<span class="keyword">new</span> <span class="title class_">MyByteSource</span>.BytesHelper()).getBytes(file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyByteSource</span><span class="params">(InputStream stream)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bytes = (<span class="keyword">new</span> <span class="title class_">MyByteSource</span>.BytesHelper()).getBytes(stream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isCompatible</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> o <span class="keyword">instanceof</span> <span class="type">byte</span>[] || o <span class="keyword">instanceof</span> <span class="type">char</span>[] || o <span class="keyword">instanceof</span> String || o <span class="keyword">instanceof</span> ByteSource || o <span class="keyword">instanceof</span> File || o <span class="keyword">instanceof</span> InputStream;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*这里加了getter和setter*/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBytes</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.bytes = bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getBytes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.bytes == <span class="literal">null</span> || <span class="built_in">this</span>.bytes.length == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toHex</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.cachedHex == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.cachedHex = Hex.encodeToString(<span class="built_in">this</span>.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.cachedHex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toBase64</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.cachedBase64 == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.cachedBase64 = Base64.encodeToString(<span class="built_in">this</span>.getBytes());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.cachedBase64;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.toBase64();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.bytes != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.bytes.length != <span class="number">0</span> ? Arrays.hashCode(<span class="built_in">this</span>.bytes) : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o <span class="keyword">instanceof</span> ByteSource) &#123;</span><br><span class="line">            <span class="type">ByteSource</span> <span class="variable">bs</span> <span class="operator">=</span> (ByteSource)o;</span><br><span class="line">            <span class="keyword">return</span> Arrays.equals(<span class="built_in">this</span>.getBytes(), bs.getBytes());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">BytesHelper</span> <span class="keyword">extends</span> <span class="title class_">CodecSupport</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">BytesHelper</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span>[] getBytes(File file) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.toBytes(file);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span>[] getBytes(InputStream stream) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.toBytes(stream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*取代原先加盐的工具类*/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Util</span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ByteSource <span class="title function_">bytes</span><span class="params">(<span class="type">byte</span>[] bytes)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyByteSource</span>(bytes);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> ByteSource <span class="title function_">bytes</span><span class="params">(String arg0)</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyByteSource</span>(arg0);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>自定义<code>UserRealm</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleAuthenticationInfo</span>(username, user.getPassword(), MyByteSource.Util.bytes(user.getSalt()), <span class="built_in">this</span>.getName());</span><br></pre></td></tr></table></figure>

<h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><p><code>AccessControlFilter</code>过滤器中有两个方法 分别为<code>isAccessAllowed</code>和<code>onAccessDenied</code></p>
<blockquote>
<p>isAccessAllowed：表示是否允许访问；mappedValue就是[urls]配置中拦截器参数部分，如果允许访问返回true，否则false；</p>
<p>onAccessDenied：表示当访问拒绝时是否已经处理了；如果返回true表示需要继续处理；如果返回false表示该拦截器实例已经处理了，将直接返回即可。</p>
</blockquote>
<hr>
<h2 id="分布式网关"><a href="#分布式网关" class="headerlink" title="分布式网关"></a>分布式网关</h2><p><strong>未完待续。。。</strong></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Devil</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://devildyw.github.io/2022/06/24/Shiro/">https://devildyw.github.io/2022/06/24/Shiro/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://devildyw.github.io" target="_blank">Devil的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post_share"><div class="social-share" data-image="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-pk9eye.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/07/02/%E8%B7%91%E6%AD%A5%E6%95%99%E7%A8%8B/"><img class="prev-cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-3zkmod.jpg" onerror="onerror=null;src='https://tva1.sinaimg.cn/large/832afe33ly1gbi8718jtpg20r00lc776.gif'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">跑步教程</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/20/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F--%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%BB%BA%E9%80%A0%E8%80%85%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><img class="next-cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/tag.jpg" onerror="onerror=null;src='https://tva1.sinaimg.cn/large/832afe33ly1gbi8718jtpg20r00lc776.gif'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">设计模式--创建型模式之建造者设计模式</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/04/24/Filter/" title="Filter"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-q2r727.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-24</div><div class="title">Filter</div></div></a></div><div><a href="/2022/02/28/ThreadLocal/" title="ThreadLocal"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-9mo7kw.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-28</div><div class="title">ThreadLocal</div></div></a></div><div><a href="/2022/02/28/%E5%8E%9F%E5%AD%90%E2%80%BB%E3%80%81%E5%8F%AF%E8%A7%81%E6%80%A7%E3%80%81%E6%9C%89%E5%BA%8F%E6%80%A7/" title="java原子性是什么_中级Java应该清楚的概念：原子性、可见性、有序性是什么？"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-57kw88.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-28</div><div class="title">java原子性是什么_中级Java应该清楚的概念：原子性、可见性、有序性是什么？</div></div></a></div><div><a href="/2022/02/28/%E6%AF%8F%E6%97%A5%E4%B8%80%E8%AE%B0--synchronized%E5%85%B3%E9%94%AE%E5%AD%97/" title="每日一记--synchronized关键字"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-k7zdqm.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-28</div><div class="title">每日一记--synchronized关键字</div></div></a></div><div><a href="/2022/02/28/%E6%AF%8F%E6%97%A5%E4%B8%80%E8%AE%B0/" title="每日一记"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/wallhaven-x8p813.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-28</div><div class="title">每日一记</div></div></a></div><div><a href="/2022/02/28/%E6%AF%8F%E6%97%A5%E4%B8%80%E8%AE%B0--%E5%A4%9A%E7%BA%BF%E7%A8%8B%EF%BC%88%E7%BB%AD%EF%BC%89/" title="每日一记--多线程（续）"><img class="cover" src="https://ding-blog.oss-cn-chengdu.aliyuncs.com/images/archive.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-28</div><div class="title">每日一记--多线程（续）</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Shiro"><span class="toc-number">1.</span> <span class="toc-text">Shiro</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.</span> <span class="toc-text">Shiro的功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">Shiro架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.1.</span> <span class="toc-text">内部架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Realm"><span class="toc-number">1.4.</span> <span class="toc-text">自定义Realm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8API"><span class="toc-number">1.5.</span> <span class="toc-text">常用API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Subject"><span class="toc-number">1.5.1.</span> <span class="toc-text">Subject</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web%E9%A1%B9%E7%9B%AE%E4%B8%8BShiro%E5%86%85%E7%BD%AE%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.6.</span> <span class="toc-text">Web项目下Shiro内置的过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.7.</span> <span class="toc-text">自定义过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8%E4%BD%BF%E5%85%B6%E7%94%9F%E6%95%88"><span class="toc-number">1.7.1.</span> <span class="toc-text">添加自己的过滤器使其生效</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E5%9F%BA%E7%A1%80%E4%BA%94%E5%BC%A0%E8%A1%A8"><span class="toc-number">1.8.</span> <span class="toc-text">Shiro基础五张表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B%EF%BC%88%E9%9B%86%E6%88%90SpringBoot-Mybatis-plus%EF%BC%89"><span class="toc-number">1.9.</span> <span class="toc-text">快速开始（集成SpringBoot+Mybatis-plus）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E8%A1%A8"><span class="toc-number">1.9.1.</span> <span class="toc-text">建表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.9.2.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maven%E4%BE%9D%E8%B5%96"><span class="toc-number">1.9.3.</span> <span class="toc-text">maven依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">1.9.4.</span> <span class="toc-text">实体类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service%E7%B1%BB"><span class="toc-number">1.9.5.</span> <span class="toc-text">Service类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Realm-1"><span class="toc-number">1.9.6.</span> <span class="toc-text">自定义Realm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ShiroConfig"><span class="toc-number">1.9.7.</span> <span class="toc-text">ShiroConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8Shiro%E6%B3%A8%E8%A7%A3%E8%BF%9B%E8%A1%8C%E9%89%B4%E6%9D%83"><span class="toc-number">1.9.8.</span> <span class="toc-text">启用Shiro注解进行鉴权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E6%95%B4%E5%90%88Spring%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="toc-number">1.10.</span> <span class="toc-text">Shiro整合Spring常用注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Realm%E9%87%87%E7%94%A8Redis%E4%BD%9C%E4%B8%BA%E7%BC%93%E5%AD%98"><span class="toc-number">1.11.</span> <span class="toc-text">Realm采用Redis作为缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring%E5%AE%B9%E5%99%A8%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">1.11.1.</span> <span class="toc-text">Spring容器工具类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shiro%E5%85%B1%E4%BA%ABSession"><span class="toc-number">1.12.</span> <span class="toc-text">Shiro共享Session</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.12.1.</span> <span class="toc-text">会话的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%9A%E8%AF%9D%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">1.12.2.</span> <span class="toc-text">分布式会话实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.12.3.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E5%AF%86%E7%A0%81%E9%87%8D%E8%AF%95%E6%AC%A1%E6%95%B0"><span class="toc-number">1.13.</span> <span class="toc-text">限制密码重试次数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.13.1.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">1.13.2.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF%E5%B9%B6%E5%8F%91%E7%99%BB%E5%BD%95%E4%BA%BA%E6%95%B0%E6%8E%A7%E5%88%B6"><span class="toc-number">1.14.</span> <span class="toc-text">在线并发登录人数控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.14.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">1.14.2.</span> <span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBoot-Shiro-Jwt%E6%95%B4%E5%90%88"><span class="toc-number">1.15.</span> <span class="toc-text">SpringBoot+Shiro+Jwt整合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%BF%BD%E8%B8%AA"><span class="toc-number">1.15.1.</span> <span class="toc-text">问题追踪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.15.2.</span> <span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT%E6%A6%82%E8%BF%B0"><span class="toc-number">1.15.3.</span> <span class="toc-text">JWT概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.15.4.</span> <span class="toc-text">代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">1.16.</span> <span class="toc-text">注意</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%90%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.16.1.</span> <span class="toc-text">盐序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.16.2.</span> <span class="toc-text">过滤器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BD%91%E5%85%B3"><span class="toc-number">1.17.</span> <span class="toc-text">分布式网关</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Devil</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">无它,唯手熟尔</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>